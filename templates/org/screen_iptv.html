{% extends "org/base.html" %}

{% block page_title %}OnlineTV - {{ screen.name }}{% endblock %}

{% block main_content %}
<div class="mb-6">
    <a href="{{ url_for('org.screen_detail', screen_id=screen.id) }}" class="text-gray-500 hover:text-gray-700">
        <i class="fas fa-arrow-left mr-2"></i>Retour à l'écran
    </a>
</div>

<div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6">
    <div class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-4">
            <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
                <i class="fas fa-tv text-purple-600 text-xl"></i>
            </div>
            <div>
                <h2 class="text-xl font-bold text-gray-800">OnlineTV - {{ screen.name }}</h2>
                <p class="text-gray-500">Gérer les chaînes OnlineTV de cet écran</p>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <span class="px-3 py-1 rounded-full text-sm font-medium {% if screen.current_mode == 'iptv' %}bg-purple-100 text-purple-700{% else %}bg-gray-100 text-gray-700{% endif %}">
                Mode: {{ 'OnlineTV' if screen.current_mode == 'iptv' else 'Playlist' }}
            </span>
        </div>
    </div>

    <div class="grid md:grid-cols-2 gap-4 mb-6">
        <form action="{{ url_for('screen.set_mode', screen_id=screen.id) }}" method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="mode" value="playlist">
            <button type="submit" class="w-full p-4 rounded-xl border-2 transition flex items-center gap-3 {% if screen.current_mode == 'playlist' %}border-primary-500 bg-primary-50{% else %}border-gray-200 hover:border-primary-300 hover:bg-gray-50{% endif %}">
                <div class="w-10 h-10 rounded-lg flex items-center justify-center {% if screen.current_mode == 'playlist' %}bg-primary-500 text-white{% else %}bg-gray-100 text-gray-500{% endif %}">
                    <i class="fas fa-list"></i>
                </div>
                <div class="text-left">
                    <div class="font-semibold text-gray-800">Lancer Playlist</div>
                    <p class="text-sm text-gray-500">Diffuser la playlist configurée</p>
                </div>
                {% if screen.current_mode == 'playlist' %}
                <span class="ml-auto px-2 py-1 bg-primary-500 text-white rounded text-xs font-medium">Actif</span>
                {% endif %}
            </button>
        </form>
        <form action="{{ url_for('screen.set_mode', screen_id=screen.id) }}" method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="mode" value="iptv">
            <button type="submit" class="w-full p-4 rounded-xl border-2 transition flex items-center gap-3 {% if screen.current_mode == 'iptv' %}border-purple-500 bg-purple-50{% else %}border-gray-200 hover:border-purple-300 hover:bg-gray-50{% endif %}">
                <div class="w-10 h-10 rounded-lg flex items-center justify-center {% if screen.current_mode == 'iptv' %}bg-purple-500 text-white{% else %}bg-gray-100 text-gray-500{% endif %}">
                    <i class="fas fa-tv"></i>
                </div>
                <div class="text-left">
                    <div class="font-semibold text-gray-800">Lancer OnlineTV</div>
                    <p class="text-sm text-gray-500">Diffuser une chaîne OnlineTV</p>
                </div>
                {% if screen.current_mode == 'iptv' %}
                <span class="ml-auto px-2 py-1 bg-purple-500 text-white rounded text-xs font-medium">Actif</span>
                {% endif %}
            </button>
        </form>
    </div>

    {% if screen.current_mode == 'iptv' and screen.current_iptv_channel_name %}
    <div class="bg-purple-50 border border-purple-200 rounded-xl p-4 mb-6">
        <div class="flex items-center gap-3">
            <i class="fas fa-broadcast-tower text-purple-600"></i>
            <div>
                <p class="text-sm text-purple-600">Chaîne en cours de diffusion</p>
                <p class="font-semibold text-purple-800">{{ screen.current_iptv_channel_name }}</p>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
    <h3 class="font-semibold text-gray-800 mb-4 flex items-center gap-2">
        <i class="fas fa-satellite-dish text-purple-600"></i>
        Liste des chaînes OnlineTV ({{ channels|length }}{% if total_channels %} sur {{ total_channels }}{% endif %})
    </h3>

    {% if total_channels > 0 %}
    <form method="GET" class="mb-4 flex gap-2">
        <input type="text" name="q" value="{{ search_query or '' }}" placeholder="Rechercher une chaîne..." 
            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
        <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
            <i class="fas fa-search"></i>
        </button>
        {% if search_query %}
        <a href="{{ url_for('org.screen_iptv', screen_id=screen.id) }}" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">
            <i class="fas fa-times"></i>
        </a>
        {% endif %}
    </form>
    
    {% if search_query %}
    <div class="mb-4 p-3 bg-purple-50 rounded-lg text-sm text-purple-700">
        <i class="fas fa-info-circle mr-2"></i>
        Résultats pour "{{ search_query }}" - {{ channels|length }} chaîne(s) trouvée(s)
    </div>
    {% endif %}
    {% endif %}

    {% if channels %}

    {% if grouped_channels %}
    <div class="space-y-6" id="channels-container">
        {% for group, group_channels in grouped_channels.items() %}
        <div class="channel-group">
            <h4 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-3 flex items-center gap-2">
                <i class="fas fa-folder text-gray-400"></i>
                {{ group }} ({{ group_channels|length }})
            </h4>
            <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-3">
                {% for channel in group_channels %}
                <form action="{{ url_for('screen.set_iptv_channel', screen_id=screen.id) }}" method="POST" class="channel-item">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="channel_url" value="{{ channel.url }}">
                    <input type="hidden" name="channel_name" value="{{ channel.name }}">
                    <button type="submit" class="w-full p-3 rounded-lg border transition text-left flex items-center gap-3 
                        {% if screen.current_iptv_channel == channel.url %}border-purple-500 bg-purple-50{% else %}border-gray-200 hover:border-purple-300 hover:bg-gray-50{% endif %}">
                        {% if channel.logo %}
                        <img src="{{ channel.logo }}" alt="{{ channel.name }}" class="w-10 h-10 rounded object-cover bg-gray-100" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="w-10 h-10 rounded bg-purple-100 items-center justify-center hidden">
                            <i class="fas fa-tv text-purple-600 text-sm"></i>
                        </div>
                        {% else %}
                        <div class="w-10 h-10 rounded bg-purple-100 flex items-center justify-center">
                            <i class="fas fa-tv text-purple-600 text-sm"></i>
                        </div>
                        {% endif %}
                        <div class="flex-1 min-w-0">
                            <p class="font-medium text-gray-800 truncate channel-name">{{ channel.name }}</p>
                            {% if channel.group and channel.group != group %}
                            <p class="text-xs text-gray-500 truncate">{{ channel.group }}</p>
                            {% endif %}
                        </div>
                        {% if screen.current_iptv_channel == channel.url %}
                        <span class="px-2 py-0.5 bg-purple-500 text-white rounded text-xs">En cours</span>
                        {% endif %}
                    </button>
                </form>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-3" id="channels-container">
        {% for channel in channels %}
        <form action="{{ url_for('screen.set_iptv_channel', screen_id=screen.id) }}" method="POST" class="channel-item">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="channel_url" value="{{ channel.url }}">
            <input type="hidden" name="channel_name" value="{{ channel.name }}">
            <button type="submit" class="w-full p-3 rounded-lg border transition text-left flex items-center gap-3 
                {% if screen.current_iptv_channel == channel.url %}border-purple-500 bg-purple-50{% else %}border-gray-200 hover:border-purple-300 hover:bg-gray-50{% endif %}">
                {% if channel.logo %}
                <img src="{{ channel.logo }}" alt="{{ channel.name }}" class="w-10 h-10 rounded object-cover bg-gray-100" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <div class="w-10 h-10 rounded bg-purple-100 items-center justify-center hidden">
                    <i class="fas fa-tv text-purple-600 text-sm"></i>
                </div>
                {% else %}
                <div class="w-10 h-10 rounded bg-purple-100 flex items-center justify-center">
                    <i class="fas fa-tv text-purple-600 text-sm"></i>
                </div>
                {% endif %}
                <div class="flex-1 min-w-0">
                    <p class="font-medium text-gray-800 truncate channel-name">{{ channel.name }}</p>
                </div>
                {% if screen.current_iptv_channel == channel.url %}
                <span class="px-2 py-0.5 bg-purple-500 text-white rounded text-xs">En cours</span>
                {% endif %}
            </button>
        </form>
        {% endfor %}
    </div>
    {% endif %}
    {% if total_pages > 1 %}
    <div class="mt-6 flex items-center justify-between border-t border-gray-200 pt-4">
        <div class="text-sm text-gray-500">
            Page {{ current_page }} sur {{ total_pages }}
        </div>
        <div class="flex gap-2">
            {% if current_page > 1 %}
            <a href="{{ url_for('org.screen_iptv', screen_id=screen.id, page=current_page-1, q=search_query or '') }}" 
               class="px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition">
                <i class="fas fa-chevron-left"></i> Précédent
            </a>
            {% endif %}
            
            {% for p in range(1, total_pages + 1) %}
                {% if p == current_page %}
                <span class="px-3 py-1 bg-purple-600 text-white rounded">{{ p }}</span>
                {% elif p == 1 or p == total_pages or (p >= current_page - 2 and p <= current_page + 2) %}
                <a href="{{ url_for('org.screen_iptv', screen_id=screen.id, page=p, q=search_query or '') }}" 
                   class="px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition">{{ p }}</a>
                {% elif p == current_page - 3 or p == current_page + 3 %}
                <span class="px-2 py-1 text-gray-500">...</span>
                {% endif %}
            {% endfor %}
            
            {% if current_page < total_pages %}
            <a href="{{ url_for('org.screen_iptv', screen_id=screen.id, page=current_page+1, q=search_query or '') }}" 
               class="px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition">
                Suivant <i class="fas fa-chevron-right"></i>
            </a>
            {% endif %}
        </div>
    </div>
    {% endif %}
    
    {% else %}
    <div class="text-center py-12">
        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <i class="fas fa-satellite-dish text-gray-400 text-2xl"></i>
        </div>
        <h4 class="font-semibold text-gray-700 mb-2">Aucune chaîne disponible</h4>
        <p class="text-gray-500 text-sm">{% if search_query %}Aucun résultat pour "{{ search_query }}".{% else %}Le fichier M3U ne contient aucune chaîne ou n'est pas accessible.{% endif %}</p>
        {% if search_query %}
        <a href="{{ url_for('org.screen_iptv', screen_id=screen.id) }}" class="mt-3 inline-block px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
            Voir toutes les chaînes
        </a>
        {% else %}
        <p class="text-gray-400 text-xs mt-2">Vérifiez le lien M3U dans les paramètres de l'établissement.</p>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}
