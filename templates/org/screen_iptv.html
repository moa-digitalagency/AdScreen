{% extends "org/base.html" %}

{% block page_title %}IPTV - {{ screen.name }}{% endblock %}

{% block main_content %}
<div class="mb-6">
    <a href="{{ url_for('org.screen_detail', screen_id=screen.id) }}" class="text-gray-500 hover:text-gray-700">
        <i class="fas fa-arrow-left mr-2"></i>Retour à l'écran
    </a>
</div>

<div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6">
    <div class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-4">
            <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
                <i class="fas fa-tv text-purple-600 text-xl"></i>
            </div>
            <div>
                <h2 class="text-xl font-bold text-gray-800">IPTV - {{ screen.name }}</h2>
                <p class="text-gray-500">Gérer les chaînes IPTV de cet écran</p>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <span class="px-3 py-1 rounded-full text-sm font-medium {% if screen.current_mode == 'iptv' %}bg-purple-100 text-purple-700{% else %}bg-gray-100 text-gray-700{% endif %}">
                Mode: {{ 'IPTV' if screen.current_mode == 'iptv' else 'Playlist' }}
            </span>
        </div>
    </div>

    <div class="grid md:grid-cols-2 gap-4 mb-6">
        <form action="{{ url_for('screen.set_mode', screen_id=screen.id) }}" method="POST">
            <input type="hidden" name="mode" value="playlist">
            <button type="submit" class="w-full p-4 rounded-xl border-2 transition flex items-center gap-3 {% if screen.current_mode == 'playlist' %}border-primary-500 bg-primary-50{% else %}border-gray-200 hover:border-primary-300 hover:bg-gray-50{% endif %}">
                <div class="w-10 h-10 rounded-lg flex items-center justify-center {% if screen.current_mode == 'playlist' %}bg-primary-500 text-white{% else %}bg-gray-100 text-gray-500{% endif %}">
                    <i class="fas fa-list"></i>
                </div>
                <div class="text-left">
                    <div class="font-semibold text-gray-800">Lancer Playlist</div>
                    <p class="text-sm text-gray-500">Diffuser la playlist configurée</p>
                </div>
                {% if screen.current_mode == 'playlist' %}
                <span class="ml-auto px-2 py-1 bg-primary-500 text-white rounded text-xs font-medium">Actif</span>
                {% endif %}
            </button>
        </form>
        <form action="{{ url_for('screen.set_mode', screen_id=screen.id) }}" method="POST">
            <input type="hidden" name="mode" value="iptv">
            <button type="submit" class="w-full p-4 rounded-xl border-2 transition flex items-center gap-3 {% if screen.current_mode == 'iptv' %}border-purple-500 bg-purple-50{% else %}border-gray-200 hover:border-purple-300 hover:bg-gray-50{% endif %}">
                <div class="w-10 h-10 rounded-lg flex items-center justify-center {% if screen.current_mode == 'iptv' %}bg-purple-500 text-white{% else %}bg-gray-100 text-gray-500{% endif %}">
                    <i class="fas fa-tv"></i>
                </div>
                <div class="text-left">
                    <div class="font-semibold text-gray-800">Lancer IPTV</div>
                    <p class="text-sm text-gray-500">Diffuser une chaîne IPTV</p>
                </div>
                {% if screen.current_mode == 'iptv' %}
                <span class="ml-auto px-2 py-1 bg-purple-500 text-white rounded text-xs font-medium">Actif</span>
                {% endif %}
            </button>
        </form>
    </div>

    {% if screen.current_mode == 'iptv' and screen.current_iptv_channel_name %}
    <div class="bg-purple-50 border border-purple-200 rounded-xl p-4 mb-6">
        <div class="flex items-center gap-3">
            <i class="fas fa-broadcast-tower text-purple-600"></i>
            <div>
                <p class="text-sm text-purple-600">Chaîne en cours de diffusion</p>
                <p class="font-semibold text-purple-800">{{ screen.current_iptv_channel_name }}</p>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
    <h3 class="font-semibold text-gray-800 mb-4 flex items-center gap-2">
        <i class="fas fa-satellite-dish text-purple-600"></i>
        Liste des chaînes ({{ channels|length }})
    </h3>

    {% if channels %}
    <div class="mb-4">
        <input type="text" id="channel-search" placeholder="Rechercher une chaîne..." 
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
    </div>

    {% if grouped_channels %}
    <div class="space-y-6" id="channels-container">
        {% for group, group_channels in grouped_channels.items() %}
        <div class="channel-group">
            <h4 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-3 flex items-center gap-2">
                <i class="fas fa-folder text-gray-400"></i>
                {{ group }} ({{ group_channels|length }})
            </h4>
            <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-3">
                {% for channel in group_channels %}
                <form action="{{ url_for('screen.set_iptv_channel', screen_id=screen.id) }}" method="POST" class="channel-item">
                    <input type="hidden" name="channel_url" value="{{ channel.url }}">
                    <input type="hidden" name="channel_name" value="{{ channel.name }}">
                    <button type="submit" class="w-full p-3 rounded-lg border transition text-left flex items-center gap-3 
                        {% if screen.current_iptv_channel == channel.url %}border-purple-500 bg-purple-50{% else %}border-gray-200 hover:border-purple-300 hover:bg-gray-50{% endif %}">
                        {% if channel.logo %}
                        <img src="{{ channel.logo }}" alt="{{ channel.name }}" class="w-10 h-10 rounded object-cover bg-gray-100" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="w-10 h-10 rounded bg-purple-100 items-center justify-center hidden">
                            <i class="fas fa-tv text-purple-600 text-sm"></i>
                        </div>
                        {% else %}
                        <div class="w-10 h-10 rounded bg-purple-100 flex items-center justify-center">
                            <i class="fas fa-tv text-purple-600 text-sm"></i>
                        </div>
                        {% endif %}
                        <div class="flex-1 min-w-0">
                            <p class="font-medium text-gray-800 truncate channel-name">{{ channel.name }}</p>
                            {% if channel.group and channel.group != group %}
                            <p class="text-xs text-gray-500 truncate">{{ channel.group }}</p>
                            {% endif %}
                        </div>
                        {% if screen.current_iptv_channel == channel.url %}
                        <span class="px-2 py-0.5 bg-purple-500 text-white rounded text-xs">En cours</span>
                        {% endif %}
                    </button>
                </form>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-3" id="channels-container">
        {% for channel in channels %}
        <form action="{{ url_for('screen.set_iptv_channel', screen_id=screen.id) }}" method="POST" class="channel-item">
            <input type="hidden" name="channel_url" value="{{ channel.url }}">
            <input type="hidden" name="channel_name" value="{{ channel.name }}">
            <button type="submit" class="w-full p-3 rounded-lg border transition text-left flex items-center gap-3 
                {% if screen.current_iptv_channel == channel.url %}border-purple-500 bg-purple-50{% else %}border-gray-200 hover:border-purple-300 hover:bg-gray-50{% endif %}">
                {% if channel.logo %}
                <img src="{{ channel.logo }}" alt="{{ channel.name }}" class="w-10 h-10 rounded object-cover bg-gray-100" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <div class="w-10 h-10 rounded bg-purple-100 items-center justify-center hidden">
                    <i class="fas fa-tv text-purple-600 text-sm"></i>
                </div>
                {% else %}
                <div class="w-10 h-10 rounded bg-purple-100 flex items-center justify-center">
                    <i class="fas fa-tv text-purple-600 text-sm"></i>
                </div>
                {% endif %}
                <div class="flex-1 min-w-0">
                    <p class="font-medium text-gray-800 truncate channel-name">{{ channel.name }}</p>
                </div>
                {% if screen.current_iptv_channel == channel.url %}
                <span class="px-2 py-0.5 bg-purple-500 text-white rounded text-xs">En cours</span>
                {% endif %}
            </button>
        </form>
        {% endfor %}
    </div>
    {% endif %}
    {% else %}
    <div class="text-center py-12">
        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <i class="fas fa-satellite-dish text-gray-400 text-2xl"></i>
        </div>
        <h4 class="font-semibold text-gray-700 mb-2">Aucune chaîne disponible</h4>
        <p class="text-gray-500 text-sm">Le fichier M3U ne contient aucune chaîne ou n'est pas accessible.</p>
        <p class="text-gray-400 text-xs mt-2">Vérifiez le lien M3U dans les paramètres de l'établissement.</p>
    </div>
    {% endif %}
</div>

<script>
document.getElementById('channel-search')?.addEventListener('input', function(e) {
    const search = e.target.value.toLowerCase();
    const items = document.querySelectorAll('.channel-item');
    const groups = document.querySelectorAll('.channel-group');
    
    items.forEach(item => {
        const name = item.querySelector('.channel-name')?.textContent.toLowerCase() || '';
        item.style.display = name.includes(search) ? '' : 'none';
    });
    
    groups.forEach(group => {
        const visibleItems = group.querySelectorAll('.channel-item[style=""], .channel-item:not([style])');
        group.style.display = visibleItems.length > 0 ? '' : 'none';
    });
});
</script>
{% endblock %}
