{% extends "org/base.html" %}

{% block page_title %}Fillers - {{ screen.name }}{% endblock %}

{% block main_content %}
<div class="mb-4 sm:mb-6">
    <a href="{{ url_for('org.screen_detail', screen_id=screen.id) }}" class="text-gray-500 hover:text-gray-700 text-sm">
        <i class="fas fa-arrow-left mr-2"></i>Retour à l'écran
    </a>
</div>

<div class="space-y-4 sm:space-y-6">
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 sm:p-6">
        <div class="flex items-center gap-3 sm:gap-4 mb-4 sm:mb-6">
            <div class="w-10 h-10 sm:w-12 sm:h-12 bg-purple-100 rounded-xl flex items-center justify-center">
                <i class="fas fa-images text-purple-600 text-lg sm:text-xl"></i>
            </div>
            <div>
                <h2 class="text-lg sm:text-xl font-bold text-gray-800">Ajouter un Filler</h2>
                <p class="text-gray-500 text-xs sm:text-sm">Image ou vidéo de remplissage</p>
            </div>
        </div>

        <form method="POST" enctype="multipart/form-data" class="space-y-4 sm:space-y-6">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div>
                <label class="label">Fichier (image ou vidéo)</label>
                <input type="file" name="file" accept="image/*,video/*" required
                    class="w-full px-4 py-3 border-2 border-dashed border-gray-300 rounded-xl focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 transition bg-gray-50 hover:bg-white cursor-pointer file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-emerald-50 file:text-emerald-600 hover:file:bg-emerald-100">
            </div>
            <button type="submit" class="inline-flex items-center justify-center gap-2 px-6 py-2.5 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold rounded-lg transition">
                <i class="fas fa-upload"></i>
                <span>Ajouter</span>
            </button>
        </form>
    </div>
    
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 sm:p-6">
        <div class="flex items-center gap-3 sm:gap-4 mb-4 sm:mb-6">
            <div class="w-10 h-10 sm:w-12 sm:h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                <i class="fas fa-info-circle text-blue-600 text-lg sm:text-xl"></i>
            </div>
            <div>
                <h2 class="text-lg sm:text-xl font-bold text-gray-800">Résolution de l'écran</h2>
                <p class="text-gray-500 text-xs sm:text-sm">{{ screen.resolution_width }}x{{ screen.resolution_height }} ({{ screen.orientation }})</p>
            </div>
        </div>
        <p class="text-sm text-gray-600">Le contenu s'adaptera automatiquement à cette résolution.</p>
    </div>

    {% if fillers %}
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 sm:p-6">
        <h3 class="text-lg font-bold text-gray-800 mb-4">Mes Fillers ({{ fillers|length }})</h3>
        <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for filler in fillers %}
            <div class="bg-gray-50 rounded-lg border border-gray-200 overflow-hidden p-3">
                <div class="aspect-video bg-gray-200 rounded mb-3 cursor-pointer overflow-hidden relative"
                     onclick="openPreviewModal('{{ filler.file_path }}', '{{ filler.content_type }}', {{ screen.resolution_width }}, {{ screen.resolution_height }})">
                    {% if filler.content_type == 'image' %}
                    <img src="/{{ filler.file_path }}" alt="Filler" class="w-full h-full object-cover">
                    {% else %}
                    <video src="/{{ filler.file_path }}" class="w-full h-full object-cover" muted></video>
                    {% endif %}
                </div>
                <p class="font-medium text-gray-800 text-sm truncate mb-2">{{ filler.filename[:30] }}</p>
                <div class="flex items-center gap-2 mb-3">
                    <span class="text-xs text-gray-600 capitalize">{{ filler.content_type }}</span>
                    {% if filler.is_active %}
                    <span class="text-xs bg-emerald-100 text-emerald-700 px-2 py-1 rounded">Actif</span>
                    {% else %}
                    <span class="text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded">Inactif</span>
                    {% endif %}
                </div>
                <div class="flex gap-2">
                    <button onclick="openPreviewModal('{{ filler.file_path }}', '{{ filler.content_type }}', {{ screen.resolution_width }}, {{ screen.resolution_height }})"
                            class="flex-1 px-2 py-1.5 text-xs bg-blue-100 hover:bg-blue-200 text-blue-700 rounded transition">
                        <i class="fas fa-eye mr-1"></i>Aperçu
                    </button>
                    <form action="{{ url_for('org.toggle_filler', screen_id=screen.id, filler_id=filler.id) }}" method="POST" class="flex-1">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="w-full px-2 py-1.5 text-xs bg-amber-100 hover:bg-amber-200 text-amber-700 rounded transition">
                            <i class="fas fa-{% if filler.is_active %}pause{% else %}play{% endif %} mr-1"></i>{{ "Pause" if filler.is_active else "Play" }}
                        </button>
                    </form>
                    <form action="{{ url_for('org.delete_filler', screen_id=screen.id, filler_id=filler.id) }}" method="POST" class="flex-1">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="w-full px-2 py-1.5 text-xs bg-red-100 hover:bg-red-200 text-red-700 rounded transition"
                            onclick="return confirm('Supprimer ce filler ?')">
                            <i class="fas fa-trash mr-1"></i>Supprimer
                        </button>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% else %}
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-8 text-center">
        <i class="fas fa-images text-gray-300 text-4xl mb-3"></i>
        <h3 class="text-lg font-semibold text-gray-700 mb-2">Aucun filler</h3>
        <p class="text-sm text-gray-500">Commencez par en ajouter un ci-dessus.</p>
    </div>
    {% endif %}
</div>

<div id="previewModal" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
    <div class="max-w-5xl w-full">
        <div class="flex items-center justify-between mb-6">
            <div class="text-white">
                <h3 class="font-bold text-lg">Aperçu selon résolution écran</h3>
                <p class="text-sm text-gray-300" id="previewResolution"></p>
            </div>
            <button onclick="closePreviewModal()" class="w-10 h-10 flex items-center justify-center bg-white/10 hover:bg-white/20 rounded-xl transition">
                <i class="fas fa-times text-white text-lg"></i>
            </button>
        </div>
        <div class="bg-gray-900 rounded-2xl overflow-hidden flex items-center justify-center shadow-2xl" id="previewContainer" style="max-height: 70vh;">
        </div>
    </div>
</div>

<script>
function openPreviewModal(filePath, contentType, screenWidth, screenHeight) {
    const modal = document.getElementById('previewModal');
    const container = document.getElementById('previewContainer');
    const resolutionText = document.getElementById('previewResolution');
    
    resolutionText.textContent = `Résolution: ${screenWidth}x${screenHeight}`;
    
    const aspectRatio = screenWidth / screenHeight;
    const maxWidth = Math.min(900, window.innerWidth - 64);
    const maxHeight = window.innerHeight * 0.7;
    
    let displayWidth, displayHeight;
    if (maxWidth / maxHeight > aspectRatio) {
        displayHeight = maxHeight;
        displayWidth = displayHeight * aspectRatio;
    } else {
        displayWidth = maxWidth;
        displayHeight = displayWidth / aspectRatio;
    }
    
    container.style.width = displayWidth + 'px';
    container.style.height = displayHeight + 'px';
    
    if (contentType === 'image') {
        container.innerHTML = `<img src="/${filePath}" alt="Preview" class="w-full h-full object-contain">`;
    } else {
        container.innerHTML = `<video src="/${filePath}" controls autoplay class="w-full h-full object-contain"></video>`;
    }
    
    modal.classList.remove('hidden');
    modal.classList.add('flex');
}

function closePreviewModal() {
    const modal = document.getElementById('previewModal');
    const container = document.getElementById('previewContainer');
    
    const video = container.querySelector('video');
    if (video) video.pause();
    
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    container.innerHTML = '';
}

document.getElementById('previewModal').addEventListener('click', function(e) {
    if (e.target === this) closePreviewModal();
});
</script>
{% endblock %}
