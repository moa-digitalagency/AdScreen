{% extends "org/base.html" %}

{% block page_title %}Contenus internes - {{ screen.name }}{% endblock %}

{% block main_content %}
<div class="max-w-5xl mx-auto">
    <div class="mb-6">
        <a href="{{ url_for('org.screen_detail', screen_id=screen.id) }}" class="text-gray-500 hover:text-gray-700">
            <i class="fas fa-arrow-left mr-2"></i>Retour à {{ screen.name }}
        </a>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-8 mb-8">
        <h2 class="text-xl font-semibold text-gray-800 mb-2">Contenus internes</h2>
        <p class="text-gray-500 mb-6">Vos propres promotions et annonces, diffusées avec une priorité élevée.</p>

        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
            <div class="flex items-start gap-3">
                <i class="fas fa-info-circle text-blue-500 mt-0.5"></i>
                <div class="text-sm text-blue-700">
                    <p><strong>Résolution écran:</strong> {{ screen.resolution_width }}x{{ screen.resolution_height }} ({{ screen.orientation }})</p>
                    <p class="mt-1">Le contenu s'adaptera automatiquement à cette résolution.</p>
                </div>
            </div>
        </div>

        <form method="POST" enctype="multipart/form-data" class="space-y-6" id="internalForm">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="grid md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nom</label>
                    <input type="text" name="name" required placeholder="Ex: Promo Happy Hour"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent transition">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Priorité (1-100)</label>
                    <input type="number" name="priority" value="80" min="1" max="100"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent transition">
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Votre contenu</label>
                <div id="uploadZone" class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:border-primary-400 transition cursor-pointer"
                     onclick="document.getElementById('fileInput').click()">
                    <input type="file" name="file" id="fileInput" accept="image/*,video/*" required
                        class="hidden" onchange="onFileChange(); previewFile(this);">
                    <input type="hidden" name="content_type" id="content_type" value="image">
                    <div id="uploadPlaceholder">
                        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-cloud-upload-alt text-gray-400 text-2xl"></i>
                        </div>
                        <p class="text-gray-600 font-medium mb-1">Cliquez pour uploader</p>
                        <p class="text-sm text-gray-500">ou glissez-déposez votre fichier</p>
                        <p class="text-xs text-emerald-600 mt-3">
                            <i class="fas fa-magic mr-1"></i>
                            Votre contenu s'adaptera automatiquement à l'écran
                        </p>
                    </div>
                </div>
                
                <div id="contentPreviewSection" class="hidden mt-4">
                    <div class="bg-gray-900 rounded-xl p-4 relative">
                        <div class="text-center text-white/60 text-xs mb-3">
                            <i class="fas fa-tv mr-1"></i> Aperçu ({{ screen.resolution_width }}x{{ screen.resolution_height }})
                        </div>
                        <div id="screenSimulator" class="mx-auto bg-black rounded-lg overflow-hidden flex items-center justify-center" 
                             style="width: min(100%, {% if screen.orientation == 'portrait' %}180px{% else %}280px{% endif %}); aspect-ratio: {% if screen.orientation == 'portrait' %}9/16{% else %}16/9{% endif %};">
                            <img id="previewImage" class="max-w-full max-h-full object-contain hidden">
                            <video id="previewVideo" class="max-w-full max-h-full object-contain hidden" controls muted></video>
                        </div>
                        <p id="fileName" class="text-white/80 text-sm text-center mt-3 truncate px-2"></p>
                        <p class="text-center text-emerald-400/80 text-xs mt-2">
                            <i class="fas fa-check-circle mr-1"></i>
                            Adaptation automatique sans déformation
                        </p>
                    </div>
                    
                    <button type="button" onclick="changeFile()" class="mt-4 w-full py-2 text-sm text-gray-600 hover:text-primary-600 transition border border-gray-200 rounded-lg hover:border-primary-300">
                        <i class="fas fa-redo mr-1"></i> Changer le fichier
                    </button>
                </div>
            </div>

            <div class="border-t border-gray-200 pt-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-calendar-alt text-primary-500"></i>
                    Période de diffusion
                </h3>
                
                <div class="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg p-3 mb-4 border border-indigo-100">
                    <p class="text-sm text-indigo-700 flex items-start gap-2">
                        <i class="fas fa-clock text-indigo-500 mt-0.5"></i>
                        <span>Sélectionnez les dates <strong>et heures</strong> pour calculer automatiquement les disponibilités</span>
                    </p>
                </div>
                
                <div class="grid md:grid-cols-2 gap-4 mb-4">
                    <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl p-4 border border-green-200 shadow-sm">
                        <div class="flex items-center gap-2 mb-3">
                            <div class="w-8 h-8 bg-green-500 rounded-lg flex items-center justify-center">
                                <i class="fas fa-play text-white text-sm"></i>
                            </div>
                            <p class="font-semibold text-green-800">Début</p>
                        </div>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">
                                    <i class="fas fa-calendar-alt mr-1 text-green-600"></i>
                                    Date de début <span class="text-red-500">*</span>
                                </label>
                                <input type="date" name="start_date" id="start_date" required
                                    value="{{ now().strftime('%Y-%m-%d') }}"
                                    class="w-full px-3 py-3 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500 focus:border-transparent bg-white"
                                    onchange="onDatesChange()">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">
                                    <i class="fas fa-clock mr-1 text-green-600"></i>
                                    Heure de début
                                </label>
                                <input type="time" name="start_time" id="start_time" value="08:00"
                                    class="w-full px-3 py-3 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500 focus:border-transparent bg-white"
                                    onchange="onDatesChange()">
                            </div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-red-50 to-orange-50 rounded-xl p-4 border border-red-200 shadow-sm">
                        <div class="flex items-center gap-2 mb-3">
                            <div class="w-8 h-8 bg-red-500 rounded-lg flex items-center justify-center">
                                <i class="fas fa-stop text-white text-sm"></i>
                            </div>
                            <p class="font-semibold text-red-800">Fin</p>
                        </div>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">
                                    <i class="fas fa-calendar-alt mr-1 text-red-600"></i>
                                    Date de fin <span class="text-red-500">*</span>
                                </label>
                                <input type="date" name="end_date" id="end_date" required
                                    class="w-full px-3 py-3 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-red-500 focus:border-transparent bg-white"
                                    onchange="onDatesChange()">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">
                                    <i class="fas fa-clock mr-1 text-red-600"></i>
                                    Heure de fin
                                </label>
                                <input type="time" name="end_time" id="end_time" value="22:00"
                                    class="w-full px-3 py-3 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-red-500 focus:border-transparent bg-white"
                                    onchange="onDatesChange()">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center gap-2 text-xs text-gray-500 bg-gray-50 rounded-lg p-3 mb-4">
                    <i class="fas fa-lightbulb text-amber-500 flex-shrink-0"></i>
                    <span>Astuce: Les heures permettent un calcul plus précis du nombre de passages disponibles sur la période sélectionnée</span>
                </div>

                <div id="availability_section" class="hidden mt-4">
                    <div class="bg-gradient-to-r from-blue-50 via-indigo-50 to-purple-50 rounded-xl p-4 border border-blue-200 shadow-sm">
                        <div class="flex items-center justify-between gap-2 mb-3">
                            <div class="flex items-center gap-2">
                                <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-chart-bar text-white text-sm"></i>
                                </div>
                                <span class="font-semibold text-blue-800">Disponibilités</span>
                            </div>
                            <span id="loading_indicator" class="hidden">
                                <div class="flex items-center gap-1 text-blue-500 text-xs">
                                    <i class="fas fa-spinner fa-spin"></i>
                                </div>
                            </span>
                        </div>
                        <div class="grid grid-cols-3 gap-3">
                            <div class="bg-white rounded-xl p-3 shadow-sm border border-blue-100 text-center">
                                <div class="w-8 h-8 mx-auto mb-2 bg-blue-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-calendar-day text-blue-600 text-xs"></i>
                                </div>
                                <p class="text-xl font-bold text-blue-600" id="num_days_display">0</p>
                                <p class="text-xs text-gray-500 font-medium">Jours</p>
                            </div>
                            <div class="bg-white rounded-xl p-3 shadow-sm border border-green-100 text-center">
                                <div class="w-8 h-8 mx-auto mb-2 bg-green-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-play-circle text-green-600 text-xs"></i>
                                </div>
                                <p class="text-xl font-bold text-green-600" id="available_plays_display">0</p>
                                <p class="text-xs text-gray-500 font-medium">Passages max</p>
                            </div>
                            <div class="bg-white rounded-xl p-3 shadow-sm border border-purple-100 text-center">
                                <div class="w-8 h-8 mx-auto mb-2 bg-purple-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-stopwatch text-purple-600 text-xs"></i>
                                </div>
                                <p class="text-xl font-bold text-purple-600" id="total_seconds_display">0</p>
                                <p class="text-xs text-gray-500 font-medium">Sec. dispo</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="plays_section" class="border-t border-gray-200 pt-6 hidden">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-play-circle text-purple-500"></i>
                    Nombre de passages
                </h3>
                
                <div class="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-lg p-4 border border-purple-100 mb-4">
                    <p class="text-sm text-purple-700 flex items-start gap-2">
                        <i class="fas fa-bullhorn text-purple-500 mt-0.5"></i>
                        <span>Choisissez le nombre de diffusions souhaité (max disponible: <span id="max_plays_text" class="font-bold text-purple-600">0</span>)</span>
                    </p>
                </div>
                
                <div class="flex items-center justify-center gap-5 mb-5">
                    <button type="button" onclick="changePlayCount(-10)" 
                        class="w-14 h-14 bg-gradient-to-br from-gray-100 to-gray-200 rounded-full flex items-center justify-center hover:from-gray-200 hover:to-gray-300 transition shadow-md active:scale-95 text-gray-700">
                        <i class="fas fa-minus text-lg"></i>
                    </button>
                    <div class="relative">
                        <input type="number" name="total_plays" id="total_plays" value="10" min="1" max="100000"
                            class="w-36 text-center text-3xl font-bold border-3 border-primary-200 rounded-2xl py-4 focus:border-primary-500 focus:ring-2 focus:ring-primary-200 bg-white shadow-inner" 
                            onchange="validatePlays()">
                        <span class="absolute -bottom-2 left-1/2 transform -translate-x-1/2 bg-primary-500 text-white text-xs px-2 py-0.5 rounded-full font-medium">passages</span>
                    </div>
                    <button type="button" onclick="changePlayCount(10)" 
                        class="w-14 h-14 bg-gradient-to-br from-primary-500 to-purple-600 rounded-full flex items-center justify-center hover:from-primary-600 hover:to-purple-700 transition shadow-md active:scale-95 text-white">
                        <i class="fas fa-plus text-lg"></i>
                    </button>
                </div>
                
                <input type="hidden" name="plays_per_day" id="plays_per_day_hidden" value="10">
                <input type="hidden" name="schedule_type" value="period">
                
                <div class="bg-gradient-to-r from-amber-50 to-yellow-50 border border-amber-200 rounded-xl p-4">
                    <div class="flex items-center justify-center gap-2">
                        <div class="w-10 h-10 bg-amber-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-calendar-check text-amber-600"></i>
                        </div>
                        <div class="text-center">
                            <p class="text-sm text-amber-800">Répartition équitable</p>
                            <p class="text-xl font-bold text-amber-700">
                                <span id="plays_per_day_display">0</span>
                                <span class="text-sm font-normal">passages/jour</span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <button type="submit" class="btn-primary w-full md:w-auto">
                <i class="fas fa-plus mr-2"></i>
                Ajouter le contenu
            </button>
        </form>
    </div>

    <div class="space-y-4">
        {% for internal in internals %}
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 flex items-center gap-4">
            <div class="w-24 h-16 bg-gray-100 rounded-lg overflow-hidden flex-shrink-0 cursor-pointer"
                 onclick="openPreviewModal('{{ internal.file_path }}', '{{ internal.content_type }}', {{ screen.resolution_width }}, {{ screen.resolution_height }})">
                {% if internal.content_type == 'image' %}
                <img src="/{{ internal.file_path }}" alt="{{ internal.name }}" class="w-full h-full object-cover">
                {% else %}
                <div class="w-full h-full flex items-center justify-center bg-blue-100 relative">
                    <video src="/{{ internal.file_path }}" class="w-full h-full object-cover" muted></video>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <i class="fas fa-play text-blue-600"></i>
                    </div>
                </div>
                {% endif %}
            </div>
            <div class="flex-1">
                <h3 class="font-medium text-gray-800">{{ internal.name }}</h3>
                <p class="text-sm text-gray-500">
                    <span class="capitalize">{{ internal.content_type }}</span>
                    {% if internal.duration_seconds %} • {{ "%.1f"|format(internal.duration_seconds) }}s{% endif %}
                    {% if internal.start_date and internal.end_date %}
                    • {{ internal.start_date.strftime('%d/%m') }} - {{ internal.end_date.strftime('%d/%m/%Y') }}
                    {% endif %}
                </p>
                {% if internal.total_plays or internal.plays_per_day %}
                <p class="text-xs text-purple-600 mt-1">
                    <i class="fas fa-play-circle mr-1"></i>
                    {% if internal.total_plays %}{{ internal.total_plays }} passages total{% endif %}
                    {% if internal.total_plays and internal.plays_per_day %} ({% endif %}
                    {% if internal.plays_per_day %}~{{ internal.plays_per_day }}/jour{% endif %}
                    {% if internal.total_plays and internal.plays_per_day %}){% endif %}
                </p>
                {% endif %}
            </div>
            <div class="text-center px-4">
                <p class="text-2xl font-bold text-primary-600">{{ internal.priority }}</p>
                <p class="text-xs text-gray-500">Priorité</p>
            </div>
            <div class="flex items-center gap-2">
                <span class="px-2 py-1 rounded text-xs font-medium {% if internal.is_active %}bg-green-100 text-green-700{% else %}bg-gray-100 text-gray-700{% endif %}">
                    {{ 'Actif' if internal.is_active else 'Inactif' }}
                </span>
                <button onclick="openPreviewModal('{{ internal.file_path }}', '{{ internal.content_type }}', {{ screen.resolution_width }}, {{ screen.resolution_height }})" 
                        class="p-2 text-blue-500 hover:text-blue-700" title="Aperçu">
                    <i class="fas fa-eye"></i>
                </button>
                <form action="{{ url_for('org.toggle_screen_internal', screen_id=screen.id, internal_id=internal.id) }}" method="POST" class="inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="p-2 {% if internal.is_active %}text-yellow-500 hover:text-yellow-700{% else %}text-green-500 hover:text-green-700{% endif %}" title="{% if internal.is_active %}Désactiver{% else %}Activer{% endif %}">
                        <i class="fas fa-{% if internal.is_active %}pause{% else %}play{% endif %}"></i>
                    </button>
                </form>
                <form action="{{ url_for('org.delete_screen_internal', screen_id=screen.id, internal_id=internal.id) }}" method="POST" class="inline" onsubmit="return confirm('Supprimer ce contenu ?')">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="p-2 text-red-500 hover:text-red-700" title="Supprimer">
                        <i class="fas fa-trash"></i>
                    </button>
                </form>
            </div>
        </div>
        {% else %}
        <div class="text-center py-12">
            <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-bullhorn text-gray-400 text-2xl"></i>
            </div>
            <p class="text-gray-500">Aucun contenu interne. Ajoutez vos propres promotions.</p>
        </div>
        {% endfor %}
    </div>
</div>

<div id="previewModal" class="fixed inset-0 bg-black/90 z-50 hidden items-center justify-center p-4">
    <div class="max-w-5xl w-full">
        <div class="flex items-center justify-between mb-4">
            <div class="text-white">
                <h3 class="font-semibold">Aperçu selon résolution écran</h3>
                <p class="text-sm text-gray-400" id="previewResolution"></p>
            </div>
            <button onclick="closePreviewModal()" class="p-2 bg-white/10 hover:bg-white/20 rounded-lg transition">
                <i class="fas fa-times text-white"></i>
            </button>
        </div>
        <div class="bg-gray-900 rounded-lg overflow-hidden flex items-center justify-center" id="previewContainer" style="max-height: 70vh;">
        </div>
    </div>
</div>

<script>
const screenId = {{ screen.id }};
let maxAvailablePlays = 0;
let currentNumDays = 0;

function onFileChange() {
    const fileInput = document.getElementById('fileInput');
    const contentTypeInput = document.getElementById('content_type');
    
    if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        const ext = file.name.split('.').pop().toLowerCase();
        
        if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext)) {
            contentTypeInput.value = 'image';
        } else if (['mp4', 'webm', 'mov'].includes(ext)) {
            contentTypeInput.value = 'video';
        }
        
        onDatesChange();
    }
}

function previewFile(input) {
    const file = input.files[0];
    if (file) {
        document.getElementById('uploadZone').classList.add('hidden');
        document.getElementById('contentPreviewSection').classList.remove('hidden');
        document.getElementById('fileName').textContent = file.name;
        
        const previewImage = document.getElementById('previewImage');
        const previewVideo = document.getElementById('previewVideo');
        
        if (file.type.startsWith('image/')) {
            previewImage.classList.remove('hidden');
            previewVideo.classList.add('hidden');
            previewImage.src = URL.createObjectURL(file);
        } else if (file.type.startsWith('video/')) {
            previewVideo.classList.remove('hidden');
            previewImage.classList.add('hidden');
            previewVideo.src = URL.createObjectURL(file);
        }
    }
}

function changeFile() {
    document.getElementById('uploadZone').classList.remove('hidden');
    document.getElementById('contentPreviewSection').classList.add('hidden');
    document.getElementById('fileInput').value = '';
    const previewImage = document.getElementById('previewImage');
    const previewVideo = document.getElementById('previewVideo');
    if (previewImage) previewImage.src = '';
    if (previewVideo) previewVideo.src = '';
}

function onDatesChange() {
    const startDate = document.getElementById('start_date').value;
    const endDate = document.getElementById('end_date').value;
    const startTime = document.getElementById('start_time').value || '08:00';
    const endTime = document.getElementById('end_time').value || '22:00';
    
    if (!startDate || !endDate) {
        document.getElementById('availability_section').classList.add('hidden');
        document.getElementById('plays_section').classList.add('hidden');
        return;
    }
    
    const start = new Date(startDate);
    const end = new Date(endDate);
    
    if (end < start) {
        document.getElementById('availability_section').classList.add('hidden');
        document.getElementById('plays_section').classList.add('hidden');
        return;
    }
    
    document.getElementById('availability_section').classList.remove('hidden');
    document.getElementById('loading_indicator').classList.remove('hidden');
    
    const contentType = document.getElementById('content_type').value || 'image';
    
    fetch(`/org/screen/${screenId}/internal/availability`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': '{{ csrf_token() }}'
        },
        body: JSON.stringify({
            start_date: startDate,
            end_date: endDate,
            start_time: startTime,
            end_time: endTime,
            content_type: contentType,
            slot_duration: 10
        })
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('loading_indicator').classList.add('hidden');
        
        if (data.availability) {
            const avail = data.availability;
            currentNumDays = avail.num_days;
            maxAvailablePlays = avail.available_plays;
            
            document.getElementById('num_days_display').textContent = avail.num_days;
            document.getElementById('available_plays_display').textContent = avail.available_plays.toLocaleString();
            document.getElementById('total_seconds_display').textContent = Math.round(avail.total_available_seconds).toLocaleString();
            
            document.getElementById('max_plays_text').textContent = avail.available_plays.toLocaleString();
            
            document.getElementById('plays_section').classList.remove('hidden');
            
            const recommendedPlays = data.recommended_plays || Math.min(avail.available_plays, 50);
            document.getElementById('total_plays').value = recommendedPlays;
            document.getElementById('total_plays').max = avail.available_plays;
            
            updatePlaysPerDay();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('loading_indicator').classList.add('hidden');
    });
}

function changePlayCount(delta) {
    const input = document.getElementById('total_plays');
    let value = parseInt(input.value) || 0;
    value = Math.max(1, Math.min(maxAvailablePlays, value + delta));
    input.value = value;
    validatePlays();
}

function validatePlays() {
    const input = document.getElementById('total_plays');
    let value = parseInt(input.value) || 1;
    value = Math.max(1, Math.min(maxAvailablePlays, value));
    input.value = value;
    updatePlaysPerDay();
}

function updatePlaysPerDay() {
    const totalPlays = parseInt(document.getElementById('total_plays').value) || 0;
    const playsPerDay = currentNumDays > 0 ? Math.floor(totalPlays / currentNumDays) : totalPlays;
    
    document.getElementById('plays_per_day_display').textContent = playsPerDay;
    document.getElementById('plays_per_day_hidden').value = playsPerDay;
}

document.addEventListener('DOMContentLoaded', function() {
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 7);
    document.getElementById('end_date').value = tomorrow.toISOString().split('T')[0];
    
    onDatesChange();
});

function openPreviewModal(filePath, contentType, screenWidth, screenHeight) {
    const modal = document.getElementById('previewModal');
    const container = document.getElementById('previewContainer');
    const resolutionText = document.getElementById('previewResolution');
    
    resolutionText.textContent = `Résolution: ${screenWidth}x${screenHeight}`;
    
    const aspectRatio = screenWidth / screenHeight;
    const maxWidth = Math.min(900, window.innerWidth - 64);
    const maxHeight = window.innerHeight * 0.7;
    
    let displayWidth, displayHeight;
    if (maxWidth / maxHeight > aspectRatio) {
        displayHeight = maxHeight;
        displayWidth = displayHeight * aspectRatio;
    } else {
        displayWidth = maxWidth;
        displayHeight = displayWidth / aspectRatio;
    }
    
    container.style.width = displayWidth + 'px';
    container.style.height = displayHeight + 'px';
    
    if (contentType === 'image') {
        container.innerHTML = `<img src="/${filePath}" alt="Preview" class="w-full h-full object-contain">`;
    } else {
        container.innerHTML = `<video src="/${filePath}" controls autoplay class="w-full h-full object-contain"></video>`;
    }
    
    modal.classList.remove('hidden');
    modal.classList.add('flex');
}

function closePreviewModal() {
    const modal = document.getElementById('previewModal');
    const container = document.getElementById('previewContainer');
    
    const video = container.querySelector('video');
    if (video) video.pause();
    
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    container.innerHTML = '';
}

document.getElementById('previewModal').addEventListener('click', function(e) {
    if (e.target === this) closePreviewModal();
});
</script>
{% endblock %}
