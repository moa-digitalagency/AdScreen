{% extends "org/base.html" %}

{% block page_title %}{{ screen.name }}{% endblock %}

{% block main_content %}
<div class="mb-6">
    <a href="{{ url_for('org.screens') }}" class="text-gray-500 hover:text-gray-700">
        <i class="fas fa-arrow-left mr-2"></i>Retour aux écrans
    </a>
</div>

<div class="grid lg:grid-cols-3 gap-6 mb-8">
    <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-gray-100 p-6">
        <div class="flex items-start justify-between mb-6">
            <div class="flex items-center gap-4">
                <div class="w-16 h-16 bg-purple-100 rounded-xl flex items-center justify-center">
                    <i class="fas fa-tv text-purple-600 text-2xl"></i>
                </div>
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">{{ screen.name }}</h2>
                    <p class="text-gray-500">{{ screen.location or 'Emplacement non défini' }}</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <span class="status-dot status-{{ screen.status }}"></span>
                <span class="text-sm capitalize">{{ screen.status }}</span>
            </div>
        </div>

        <div class="grid md:grid-cols-4 gap-4 mb-6">
            <div class="bg-gray-50 rounded-lg p-4">
                <p class="text-sm text-gray-500 mb-1">Résolution</p>
                <p class="font-mono text-lg font-semibold text-gray-800">{{ screen.resolution_width }}x{{ screen.resolution_height }}</p>
            </div>
            <div class="bg-gray-50 rounded-lg p-4">
                <p class="text-sm text-gray-500 mb-1">Orientation</p>
                <p class="text-lg font-semibold text-gray-800 capitalize">{{ screen.orientation }}</p>
            </div>
            <div class="bg-green-50 rounded-lg p-4 border border-green-200">
                <p class="text-sm text-green-600 mb-1">Prix de base</p>
                <p class="text-lg font-bold text-green-700">{{ "%.2f"|format(screen.price_per_minute or 2.0) }}{{ currency_symbol }}/min</p>
            </div>
            <div class="bg-gray-50 rounded-lg p-4">
                <p class="text-sm text-gray-500 mb-1">Code unique</p>
                <p class="font-mono text-sm text-gray-800">{{ screen.unique_code }}</p>
            </div>
        </div>

        <div class="flex flex-wrap gap-3">
            <a href="{{ url_for('org.screen_playlist', screen_id=screen.id) }}" class="btn-primary btn-sm">
                <i class="fas fa-list"></i>
                Playlist
            </a>
            {% if screen.iptv_enabled and org_has_iptv %}
            <a href="{{ url_for('org.screen_iptv', screen_id=screen.id) }}" class="btn-primary btn-sm bg-purple-600 hover:bg-purple-700 border-purple-600">
                <i class="fas fa-tv"></i>
                IPTV
            </a>
            {% endif %}
            <a href="{{ url_for('org.edit_screen', screen_id=screen.id) }}" class="btn-secondary btn-sm">
                <i class="fas fa-edit"></i>
                Modifier
            </a>
            <a href="{{ url_for('org.screen_slots', screen_id=screen.id) }}" class="btn-secondary btn-sm">
                <i class="fas fa-clock"></i>
                Créneaux
            </a>
            <a href="{{ url_for('org.screen_periods', screen_id=screen.id) }}" class="btn-secondary btn-sm">
                <i class="fas fa-sun"></i>
                Périodes
            </a>
            <a href="{{ url_for('org.screen_fillers', screen_id=screen.id) }}" class="btn-secondary btn-sm">
                <i class="fas fa-images"></i>
                Fillers
            </a>
            <a href="{{ url_for('org.screen_internal', screen_id=screen.id) }}" class="btn-secondary btn-sm">
                <i class="fas fa-bullhorn"></i>
                Internes
            </a>
            <a href="{{ url_for('org.screen_overlays', screen_id=screen.id) }}" class="btn-secondary btn-sm">
                <i class="fas fa-layer-group"></i>
                Overlays
            </a>
            <a href="{{ url_for('org.screen_availability', screen_id=screen.id) }}" class="btn-secondary btn-sm">
                <i class="fas fa-calendar-check"></i>
                Disponibilités
            </a>
            <a href="{{ url_for('screen.generate_qr', screen_id=screen.id) }}" class="btn-secondary btn-sm">
                <i class="fas fa-qrcode"></i>
                QR Code
            </a>
            <a href="{{ url_for('player.display', screen_code=screen.unique_code) }}" target="_blank" class="btn-primary btn-sm">
                <i class="fas fa-eye"></i>
                Aperçu live
            </a>
        </div>
    </div>

    <div class="space-y-6">
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="font-semibold text-gray-800 mb-4">Aperçu écran</h3>
            <div class="relative bg-gray-900 rounded-lg overflow-hidden" 
                 style="aspect-ratio: {{ screen.resolution_width }}/{{ screen.resolution_height }}; max-height: 180px;">
                <iframe src="{{ url_for('player.display', screen_code=screen.unique_code) }}" 
                        class="w-full h-full border-0"
                        style="pointer-events: none; transform: scale(0.25); transform-origin: top left; width: 400%; height: 400%;"></iframe>
                <div class="absolute inset-0 flex items-center justify-center bg-black/50 opacity-0 hover:opacity-100 transition cursor-pointer"
                     onclick="window.open('{{ url_for('player.display', screen_code=screen.unique_code) }}', '_blank')">
                    <span class="bg-white text-gray-800 px-3 py-1 rounded-lg text-sm font-medium">
                        <i class="fas fa-expand mr-1"></i>Ouvrir
                    </span>
                </div>
            </div>
            <p class="text-xs text-gray-400 text-center mt-2">{{ screen.resolution_width }}x{{ screen.resolution_height }}</p>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="font-semibold text-gray-800 mb-4">Statistiques</h3>
            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <span class="text-gray-500">Revenus totaux</span>
                    <span class="font-semibold text-green-600">{{ "%.2f"|format(revenue) }}{{ currency_symbol }}</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-gray-500">Cette semaine</span>
                    <span class="font-semibold text-gray-800">{{ "%.2f"|format(weekly_revenue) }}{{ currency_symbol }}</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-gray-500">Diffusions</span>
                    <span class="font-semibold text-gray-800">{{ total_plays }}</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-gray-500">En attente</span>
                    <span class="font-semibold text-yellow-600">{{ pending_count }}</span>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="font-semibold text-gray-800 mb-4">Actions rapides</h3>
            <div class="space-y-3">
                {% if screen.iptv_enabled and org_has_iptv %}
                <form action="{{ url_for('screen.set_mode', screen_id=screen.id) }}" method="POST">
                    <input type="hidden" name="mode" value="playlist">
                    <button type="submit" class="w-full btn-sm justify-center {% if screen.current_mode == 'playlist' %}btn-primary{% else %}btn-secondary{% endif %}">
                        <i class="fas fa-list"></i>
                        Lancer Playlist
                    </button>
                </form>
                <form action="{{ url_for('screen.set_mode', screen_id=screen.id) }}" method="POST">
                    <input type="hidden" name="mode" value="iptv">
                    <button type="submit" class="w-full btn-sm justify-center {% if screen.current_mode == 'iptv' %}bg-purple-600 hover:bg-purple-700 text-white border-purple-600{% else %}btn-secondary{% endif %}">
                        <i class="fas fa-tv"></i>
                        Lancer IPTV
                    </button>
                </form>
                {% endif %}
                <form action="{{ url_for('screen.toggle_screen', screen_id=screen.id) }}" method="POST">
                    <button type="submit" class="w-full btn-secondary btn-sm justify-center">
                        <i class="fas fa-{% if screen.is_active %}pause{% else %}play{% endif %}"></i>
                        {% if screen.is_active %}Désactiver{% else %}Activer{% endif %} l'écran
                    </button>
                </form>
                <form action="{{ url_for('screen.delete_screen', screen_id=screen.id) }}" method="POST" 
                      onsubmit="return confirm('Supprimer cet écran ? Cette action est irréversible.')">
                    <button type="submit" class="w-full btn-danger-outline btn-sm justify-center">
                        <i class="fas fa-trash"></i>
                        Supprimer l'écran
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
    <div class="flex items-start gap-3">
        <i class="fas fa-info-circle text-blue-500 mt-0.5"></i>
        <div class="text-sm text-blue-700">
            <p class="font-medium mb-1">Algorithme de tarification</p>
            <p>Les prix des créneaux sont calculés automatiquement: <code class="bg-blue-100 px-1 rounded">(durée_secondes / 60) × {{ "%.2f"|format(screen.price_per_minute or 2.0) }}{{ currency_symbol }}</code></p>
            <p class="mt-1">Exemple: Slot 15s = (15/60) × {{ "%.2f"|format(screen.price_per_minute or 2.0) }}{{ currency_symbol }} = <strong>{{ "%.2f"|format((15/60) * (screen.price_per_minute or 2.0)) }}{{ currency_symbol }}</strong> par diffusion</p>
        </div>
    </div>
</div>

<div class="grid lg:grid-cols-2 gap-6">
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
        <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-gray-800">Créneaux configurés</h3>
            <a href="{{ url_for('org.screen_slots', screen_id=screen.id) }}" class="text-sm text-primary-600 hover:text-primary-700">
                <i class="fas fa-edit mr-1"></i>Modifier
            </a>
        </div>
        <div class="space-y-2">
            {% for slot in screen.time_slots|sort(attribute='duration_seconds') %}
            {% set calculated_price = (slot.duration_seconds / 60) * (screen.price_per_minute or 2.0) %}
            <div class="flex items-center justify-between py-2 border-b border-gray-100 last:border-0">
                <div class="flex items-center gap-3">
                    <span class="px-2 py-1 bg-{% if slot.content_type == 'image' %}blue{% else %}purple{% endif %}-100 text-{% if slot.content_type == 'image' %}blue{% else %}purple{% endif %}-700 rounded text-xs font-medium capitalize">
                        {{ slot.content_type }}
                    </span>
                    <span class="font-mono text-gray-800">{{ slot.duration_seconds }}s</span>
                </div>
                <div class="text-right">
                    <span class="font-semibold text-gray-800">{{ "%.2f"|format(slot.price_per_play) }}{{ currency_symbol }}</span>
                    {% if (slot.price_per_play - calculated_price)|abs > 0.01 %}
                    <span class="text-xs text-orange-500 block">personnalisé</span>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <p class="text-gray-500 text-center py-4">Aucun créneau configuré</p>
            {% endfor %}
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
        <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-gray-800">Périodes journée</h3>
            <a href="{{ url_for('org.screen_periods', screen_id=screen.id) }}" class="text-sm text-primary-600 hover:text-primary-700">
                <i class="fas fa-edit mr-1"></i>Modifier
            </a>
        </div>
        <div class="space-y-2">
            {% for period in screen.time_periods %}
            {% set period_hours = period.end_hour - period.start_hour if period.end_hour > period.start_hour else (24 - period.start_hour + period.end_hour) %}
            {% set period_seconds = period_hours * 3600 %}
            <div class="flex items-center justify-between py-2 border-b border-gray-100 last:border-0">
                <div>
                    <span class="font-medium text-gray-800">{{ period.name }}</span>
                    <span class="text-gray-500 text-sm ml-2">{{ period.start_hour }}h - {{ period.end_hour }}h</span>
                    <span class="text-xs text-gray-400 ml-1">({{ period_hours }}h)</span>
                </div>
                <div class="text-right">
                    <span class="font-mono text-gray-800">×{{ period.price_multiplier }}</span>
                    <span class="text-xs text-gray-500 block">{{ (period_seconds / 15)|int }} slots 15s max</span>
                </div>
            </div>
            {% else %}
            <p class="text-gray-500 text-center py-4">Aucune période configurée</p>
            {% endfor %}
        </div>
    </div>
</div>

<div class="mt-6 bg-yellow-50 border border-yellow-200 rounded-xl p-4">
    <div class="flex items-start gap-3">
        <i class="fas fa-video text-yellow-600 mt-0.5"></i>
        <div class="text-sm text-yellow-700">
            <p class="font-medium mb-1">Règle d'affichage vidéo</p>
            <p>Si une vidéo est plus courte que la durée du créneau réservé, le lecteur affiche la dernière image jusqu'à atteindre la durée réglementaire.</p>
            <p class="mt-1">Exemple: Vidéo de 13s dans un slot de 15s → la vidéo joue puis le dernier frame reste affiché 2s supplémentaires.</p>
        </div>
    </div>
</div>
{% endblock %}
