{% extends "org/base.html" %}

{% block page_title %}{{ t('nav.dashboard') }}{% endblock %}

{% block main_content %}
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mb-6 sm:mb-8">
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 sm:p-6 card-hover">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-xs sm:text-sm font-medium">{{ t('nav.screens') }}</p>
                <p class="text-2xl sm:text-3xl font-bold text-gray-800 mt-1">{{ total_screens }}</p>
                <p class="text-green-600 text-xs sm:text-sm mt-1">
                    <span class="status-dot status-online mr-1"></span>
                    {{ online_screens }} {% if current_lang() == 'fr' %}en ligne{% else %}online{% endif %}
                </p>
            </div>
            <div class="w-10 h-10 sm:w-12 sm:h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-tv text-purple-600 text-lg sm:text-xl"></i>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 sm:p-6 card-hover">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-xs sm:text-sm font-medium">{{ t('dashboard.pending_validations') }}</p>
                <p class="text-2xl sm:text-3xl font-bold text-gray-800 mt-1">{{ pending_validations }}</p>
                <p class="text-yellow-600 text-xs sm:text-sm mt-1">{% if current_lang() == 'fr' %}À valider{% else %}To validate{% endif %}</p>
            </div>
            <div class="w-10 h-10 sm:w-12 sm:h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-clock text-yellow-600 text-lg sm:text-xl"></i>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 sm:p-6 card-hover">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-xs sm:text-sm font-medium">{% if current_lang() == 'fr' %}CA Brut{% else %}Gross Revenue{% endif %}</p>
                <p class="text-2xl sm:text-3xl font-bold text-gray-800 mt-1">{{ "%.2f"|format(total_revenue) }} {{ currency_symbol }}</p>
                <p class="text-gray-500 text-xs sm:text-sm mt-1">{% if current_lang() == 'fr' %}Total des ventes{% else %}Total sales{% endif %}</p>
            </div>
            <div class="w-10 h-10 sm:w-12 sm:h-12 bg-green-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-coins text-green-600 text-lg sm:text-xl"></i>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 sm:p-6 card-hover">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-xs sm:text-sm font-medium">{% if current_lang() == 'fr' %}Revenu net{% else %}Net Revenue{% endif %}</p>
                <p class="text-2xl sm:text-3xl font-bold text-emerald-600 mt-1">{{ "%.2f"|format(org.calculate_net_revenue(total_revenue)) }} {{ currency_symbol }}</p>
                <p class="text-gray-500 text-xs sm:text-sm mt-1">{% if current_lang() == 'fr' %}Après commission{% else %}After commission{% endif %} ({{ org.commission_rate }}%)</p>
            </div>
            <div class="w-10 h-10 sm:w-12 sm:h-12 bg-emerald-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-wallet text-emerald-600 text-lg sm:text-xl"></i>
            </div>
        </div>
    </div>
</div>

<div class="grid sm:grid-cols-2 gap-4 sm:gap-6 mb-6 sm:mb-8">
    <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-4 sm:p-6 text-white">
        <div class="flex items-center justify-between mb-3 sm:mb-4">
            <p class="font-medium text-sm sm:text-base">{% if current_lang() == 'fr' %}CA Hebdomadaire{% else %}Weekly Revenue{% endif %}</p>
            <i class="fas fa-chart-line opacity-50"></i>
        </div>
        <p class="text-2xl sm:text-3xl font-bold">{{ "%.2f"|format(weekly_revenue) }} {{ currency_symbol }}</p>
        <p class="text-blue-100 text-xs sm:text-sm mt-1">{% if current_lang() == 'fr' %}7 derniers jours{% else %}Last 7 days{% endif %}</p>
    </div>
    
    <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-xl p-4 sm:p-6 text-white">
        <div class="flex items-center justify-between mb-3 sm:mb-4">
            <p class="font-medium text-sm sm:text-base">{% if current_lang() == 'fr' %}Revenu net hebdo{% else %}Weekly Net Revenue{% endif %}</p>
            <i class="fas fa-wallet opacity-50"></i>
        </div>
        <p class="text-2xl sm:text-3xl font-bold">{{ "%.2f"|format(org.calculate_net_revenue(weekly_revenue)) }} {{ currency_symbol }}</p>
        <p class="text-emerald-100 text-xs sm:text-sm mt-1">{% if current_lang() == 'fr' %}Commission{% else %}Commission{% endif %}: {{ "%.2f"|format(org.calculate_platform_commission(weekly_revenue)) }} {{ currency_symbol }}</p>
    </div>
</div>

{% if screens %}
<div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 sm:p-6 mb-6 sm:mb-8" id="quick-actions-section">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
        <h2 class="text-base sm:text-lg font-semibold text-gray-800">
            <i class="fas fa-bolt text-yellow-500 mr-2"></i>{{ t('dashboard.quick_actions') }}
        </h2>
        
        {% if screens|length > 1 %}
        <div class="flex items-center gap-2">
            <label for="quick-action-screen" class="text-xs sm:text-sm text-gray-600 whitespace-nowrap">
                <i class="fas fa-tv mr-1"></i>{% if current_lang() == 'fr' %}Écran:{% else %}Screen:{% endif %}
            </label>
            <select id="quick-action-screen" 
                    class="text-xs sm:text-sm border border-gray-200 rounded-lg px-3 py-1.5 bg-white focus:ring-2 focus:ring-primary-500 focus:border-primary-500 min-w-[140px]"
                    onchange="updateQuickActions(this.value)">
                {% for screen in screens %}
                <option value="{{ screen.id }}" 
                        data-name="{{ screen.name }}"
                        data-status="{{ screen.status }}"
                        {% if loop.first %}selected{% endif %}>
                    {{ screen.name }}
                </option>
                {% endfor %}
            </select>
        </div>
        {% endif %}
    </div>
    
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 sm:gap-4" id="quick-actions-grid">
        <a href="{{ url_for('org.screen_playlist', screen_id=screens[0].id) }}" 
           id="qa-playlist-link"
           class="flex flex-col items-center justify-center p-4 rounded-xl border-2 border-primary-200 bg-primary-50 hover:bg-primary-100 hover:border-primary-300 transition group">
            <div class="w-10 h-10 sm:w-12 sm:h-12 bg-primary-500 rounded-xl flex items-center justify-center mb-2 group-hover:scale-110 transition">
                <i class="fas fa-list text-white text-lg"></i>
            </div>
            <span class="text-xs sm:text-sm font-medium text-primary-700 text-center">{% if current_lang() == 'fr' %}Voir Playlist{% else %}View Playlist{% endif %}</span>
        </a>
        
        <a href="{{ url_for('org.screen_iptv', screen_id=screens[0].id) }}" 
           id="qa-iptv-link"
           class="flex flex-col items-center justify-center p-4 rounded-xl border-2 border-purple-200 bg-purple-50 hover:bg-purple-100 hover:border-purple-300 transition group">
            <div class="w-10 h-10 sm:w-12 sm:h-12 bg-purple-500 rounded-xl flex items-center justify-center mb-2 group-hover:scale-110 transition">
                <i class="fas fa-tv text-white text-lg"></i>
            </div>
            <span class="text-xs sm:text-sm font-medium text-purple-700 text-center">{% if current_lang() == 'fr' %}Voir OnlineTV{% else %}View OnlineTV{% endif %}</span>
        </a>
        
        <form action="{{ url_for('screen.set_mode', screen_id=screens[0].id) }}" method="POST" class="contents" id="qa-playlist-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="mode" value="playlist">
            <input type="hidden" name="redirect_dashboard" value="1">
            <button type="submit" 
                    class="flex flex-col items-center justify-center p-4 rounded-xl border-2 border-green-200 bg-green-50 hover:bg-green-100 hover:border-green-300 transition group w-full">
                <div class="w-10 h-10 sm:w-12 sm:h-12 bg-green-500 rounded-xl flex items-center justify-center mb-2 group-hover:scale-110 transition">
                    <i class="fas fa-play text-white text-lg"></i>
                </div>
                <span class="text-xs sm:text-sm font-medium text-green-700 text-center">{% if current_lang() == 'fr' %}Lancer Playlist{% else %}Start Playlist{% endif %}</span>
            </button>
        </form>
        
        <form action="{{ url_for('screen.set_mode', screen_id=screens[0].id) }}" method="POST" class="contents" id="qa-iptv-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="mode" value="iptv">
            <input type="hidden" name="redirect_dashboard" value="1">
            <button type="submit" 
                    class="flex flex-col items-center justify-center p-4 rounded-xl border-2 border-orange-200 bg-orange-50 hover:bg-orange-100 hover:border-orange-300 transition group w-full">
                <div class="w-10 h-10 sm:w-12 sm:h-12 bg-orange-500 rounded-xl flex items-center justify-center mb-2 group-hover:scale-110 transition">
                    <i class="fas fa-broadcast-tower text-white text-lg"></i>
                </div>
                <span class="text-xs sm:text-sm font-medium text-orange-700 text-center">{% if current_lang() == 'fr' %}Lancer OnlineTV{% else %}Start OnlineTV{% endif %}</span>
            </button>
        </form>
    </div>
    
    <div class="mt-4 pt-4 border-t border-gray-100">
        <p class="text-xs text-gray-500" id="qa-current-screen-info">
            <i class="fas fa-info-circle mr-1"></i>
            {% if current_lang() == 'fr' %}Actions pour:{% else %}Actions for:{% endif %} <strong id="qa-current-screen-name">{{ screens[0].name }}</strong>
            <span class="status-dot status-{{ screens[0].status }} w-2 h-2 ml-2 inline-block"></span>
        </p>
    </div>
</div>

<script>
function updateQuickActions(screenId) {
    const select = document.getElementById('quick-action-screen');
    const selectedOption = select.options[select.selectedIndex];
    const screenName = selectedOption.dataset.name;
    const screenStatus = selectedOption.dataset.status;
    
    const playlistLink = document.getElementById('qa-playlist-link');
    const iptvLink = document.getElementById('qa-iptv-link');
    const playlistForm = document.getElementById('qa-playlist-form');
    const iptvForm = document.getElementById('qa-iptv-form');
    const currentScreenName = document.getElementById('qa-current-screen-name');
    const currentScreenInfo = document.getElementById('qa-current-screen-info');
    
    playlistLink.href = `/org/screen/${screenId}/playlist`;
    iptvLink.href = `/org/screen/${screenId}/iptv`;
    playlistForm.action = `/screen/${screenId}/mode`;
    iptvForm.action = `/screen/${screenId}/mode`;
    
    currentScreenName.textContent = screenName;
    
    const statusDot = currentScreenInfo.querySelector('.status-dot');
    if (statusDot) {
        statusDot.className = `status-dot status-${screenStatus} w-2 h-2 ml-2 inline-block`;
    }
}
</script>
{% endif %}

<div class="grid lg:grid-cols-3 gap-4 sm:gap-6">
    <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-gray-100 p-4 sm:p-6">
        <div class="flex items-center justify-between mb-4 sm:mb-6">
            <h2 class="text-base sm:text-lg font-semibold text-gray-800">{{ t('nav.my_screens') }}</h2>
            <a href="{{ url_for('org.screens') }}" class="text-primary-600 hover:underline text-xs sm:text-sm">{% if current_lang() == 'fr' %}Voir tous{% else %}View all{% endif %}</a>
        </div>
        
        <div class="grid sm:grid-cols-2 gap-3 sm:gap-4">
            {% for screen in screens[:4] %}
            <a href="{{ url_for('org.screen_detail', screen_id=screen.id) }}" 
               class="block p-3 sm:p-4 border border-gray-100 rounded-lg hover:border-primary-200 hover:bg-primary-50/30 transition">
                <div class="flex items-start justify-between mb-2 sm:mb-3">
                    <div class="flex items-center gap-2 sm:gap-3">
                        <div class="w-8 h-8 sm:w-10 sm:h-10 bg-purple-100 rounded-lg flex items-center justify-center flex-shrink-0">
                            <i class="fas fa-tv text-purple-600 text-sm"></i>
                        </div>
                        <div class="min-w-0">
                            <p class="font-medium text-gray-800 text-sm truncate">{{ screen.name }}</p>
                            <p class="text-xs text-gray-500 truncate">{{ screen.location or (t('screens.location') if current_lang() == 'en' else 'Non défini') }}</p>
                        </div>
                    </div>
                    <span class="status-dot status-{{ screen.status }} flex-shrink-0"></span>
                </div>
                <div class="flex items-center justify-between text-xs">
                    <span class="font-mono text-gray-600">{{ screen.resolution_width }}x{{ screen.resolution_height }}</span>
                    <span class="text-gray-500 capitalize">{{ screen.orientation }}</span>
                </div>
            </a>
            {% else %}
            <div class="sm:col-span-2 text-center py-8 sm:py-12">
                <div class="w-14 h-14 sm:w-16 sm:h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-tv text-gray-400 text-xl sm:text-2xl"></i>
                </div>
                <p class="text-gray-500 mb-4 text-sm">{{ t('screens.no_screens') }}</p>
                <a href="{{ url_for('org.new_screen') }}" class="btn-primary btn-sm">
                    <i class="fas fa-plus"></i>
                    {{ t('screens.create_first') }}
                </a>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 sm:p-6">
        <h2 class="text-base sm:text-lg font-semibold text-gray-800 mb-4 sm:mb-6">{% if current_lang() == 'fr' %}Dernières réservations{% else %}Recent Bookings{% endif %}</h2>
        <div class="space-y-3 sm:space-y-4">
            {% for booking in recent_bookings[:6] %}
            <div class="flex items-center justify-between py-2 sm:py-3 border-b border-gray-100 last:border-0">
                <div class="min-w-0 flex-1">
                    <p class="font-medium text-gray-800 text-sm truncate">{{ booking.content.client_name or (t('common.none') if current_lang() == 'en' else 'Anonyme') }}</p>
                    <p class="text-xs text-gray-500 truncate">{{ booking.screen.name }}</p>
                </div>
                <div class="text-right flex-shrink-0 ml-3">
                    <p class="font-semibold text-gray-800 text-sm">{{ "%.2f"|format(booking.total_price) }} {{ currency_symbol }}</p>
                    <p class="text-xs text-gray-500">{{ booking.num_plays }} {% if current_lang() == 'fr' %}diffusions{% else %}broadcasts{% endif %}</p>
                </div>
            </div>
            {% else %}
            <p class="text-gray-500 text-center py-6 sm:py-8 text-sm">{% if current_lang() == 'fr' %}Aucune réservation{% else %}No bookings{% endif %}</p>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}
