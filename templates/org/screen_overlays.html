{% extends "org/base.html" %}

{% block page_title %}Overlays - {{ screen.name }}{% endblock %}

{% block main_content %}
<div class="mb-4 sm:mb-6">
    <a href="{{ url_for('org.screen_detail', screen_id=screen.id) }}" class="text-gray-500 hover:text-gray-700 text-sm">
        <i class="fas fa-arrow-left mr-2"></i>Retour à l'écran
    </a>
</div>

<div class="grid lg:grid-cols-2 gap-4 sm:gap-6">
    <div class="space-y-4 sm:space-y-6">
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 sm:p-6">
            <div class="flex items-center gap-3 sm:gap-4 mb-4 sm:mb-6">
                <div class="w-10 h-10 sm:w-12 sm:h-12 bg-purple-100 rounded-xl flex items-center justify-center">
                    <i class="fas fa-layer-group text-purple-600 text-lg sm:text-xl"></i>
                </div>
                <div>
                    <h2 class="text-lg sm:text-xl font-bold text-gray-800">Nouvel Overlay</h2>
                    <p class="text-gray-500 text-xs sm:text-sm">Bandeau défilant ou image superposée</p>
                </div>
            </div>

            <form method="POST" enctype="multipart/form-data" id="overlayForm" class="space-y-4 sm:space-y-6">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div>
                    <label class="label">Type d'overlay</label>
                    <div class="grid grid-cols-2 gap-3">
                        <label class="relative cursor-pointer">
                            <input type="radio" name="overlay_type" value="ticker" checked class="peer sr-only" onchange="switchOverlayType('ticker')">
                            <div class="p-3 sm:p-4 border-2 border-gray-200 rounded-xl peer-checked:border-emerald-500 peer-checked:bg-emerald-50 transition">
                                <div class="flex items-center gap-2 sm:gap-3">
                                    <div class="w-8 h-8 sm:w-10 sm:h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-align-left text-blue-600 text-sm sm:text-base"></i>
                                    </div>
                                    <div>
                                        <p class="font-medium text-gray-800 text-sm sm:text-base">Bandeau</p>
                                        <p class="text-xs text-gray-500">Texte défilant</p>
                                    </div>
                                </div>
                            </div>
                        </label>
                        <label class="relative cursor-pointer">
                            <input type="radio" name="overlay_type" value="image" class="peer sr-only" onchange="switchOverlayType('image')">
                            <div class="p-3 sm:p-4 border-2 border-gray-200 rounded-xl peer-checked:border-emerald-500 peer-checked:bg-emerald-50 transition">
                                <div class="flex items-center gap-2 sm:gap-3">
                                    <div class="w-8 h-8 sm:w-10 sm:h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-image text-purple-600 text-sm sm:text-base"></i>
                                    </div>
                                    <div>
                                        <p class="font-medium text-gray-800 text-sm sm:text-base">Image</p>
                                        <p class="text-xs text-gray-500">Logo, watermark</p>
                                    </div>
                                </div>
                            </div>
                        </label>
                    </div>
                </div>

                <div id="tickerFields">
                    <div class="space-y-4">
                        <div>
                            <label class="label">Position du bandeau</label>
                            <div class="grid grid-cols-3 gap-2">
                                <label class="relative cursor-pointer">
                                    <input type="radio" name="position" value="header" class="peer sr-only" onchange="updateLivePreview()">
                                    <div class="p-2 sm:p-3 border border-gray-200 rounded-lg peer-checked:border-emerald-500 peer-checked:bg-emerald-50 text-center transition">
                                        <i class="fas fa-arrow-up text-gray-500 peer-checked:text-emerald-600 mb-1"></i>
                                        <p class="text-xs font-medium">Haut</p>
                                    </div>
                                </label>
                                <label class="relative cursor-pointer">
                                    <input type="radio" name="position" value="body" class="peer sr-only" onchange="updateLivePreview()">
                                    <div class="p-2 sm:p-3 border border-gray-200 rounded-lg peer-checked:border-emerald-500 peer-checked:bg-emerald-50 text-center transition">
                                        <i class="fas fa-dot-circle text-gray-500 peer-checked:text-emerald-600 mb-1"></i>
                                        <p class="text-xs font-medium">Centre</p>
                                    </div>
                                </label>
                                <label class="relative cursor-pointer">
                                    <input type="radio" name="position" value="footer" checked class="peer sr-only" onchange="updateLivePreview()">
                                    <div class="p-2 sm:p-3 border border-gray-200 rounded-lg peer-checked:border-emerald-500 peer-checked:bg-emerald-50 text-center transition">
                                        <i class="fas fa-arrow-down text-gray-500 peer-checked:text-emerald-600 mb-1"></i>
                                        <p class="text-xs font-medium">Bas</p>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <div>
                            <label class="label">Message du bandeau</label>
                            <textarea name="message" id="tickerMessage" rows="2" class="input-field text-sm" 
                                placeholder="Entrez votre message qui défilera..." oninput="updateLivePreview()"></textarea>
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="label">Couleur de fond</label>
                                <div class="flex gap-2">
                                    <input type="color" name="background_color" id="bgColor" value="#1f2937" 
                                        class="w-10 h-10 rounded-lg border border-gray-300 cursor-pointer" onchange="updateLivePreview()">
                                    <input type="text" id="bgColorText" value="#1f2937" class="input-field flex-1 font-mono text-xs" 
                                        oninput="document.getElementById('bgColor').value = this.value; updateLivePreview();">
                                </div>
                            </div>
                            <div>
                                <label class="label">Couleur du texte</label>
                                <div class="flex gap-2">
                                    <input type="color" name="text_color" id="textColor" value="#ffffff" 
                                        class="w-10 h-10 rounded-lg border border-gray-300 cursor-pointer" onchange="updateLivePreview()">
                                    <input type="text" id="textColorText" value="#ffffff" class="input-field flex-1 font-mono text-xs"
                                        oninput="document.getElementById('textColor').value = this.value; updateLivePreview();">
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="label">Taille du texte</label>
                                <div class="flex items-center gap-2">
                                    <input type="range" name="font_size" id="fontSize" min="16" max="72" value="28" 
                                        class="flex-1" oninput="updateFontSizeLabel(); updateLivePreview();">
                                    <span id="fontSizeLabel" class="text-sm font-mono w-12 text-right">28px</span>
                                </div>
                            </div>
                            <div>
                                <label class="label">Vitesse de défilement</label>
                                <div class="flex items-center gap-2">
                                    <input type="range" name="scroll_speed" id="scrollSpeed" min="20" max="150" value="60" 
                                        class="flex-1" oninput="updateSpeedLabel(); updateLivePreview();">
                                    <span id="speedLabel" class="text-sm font-mono w-10 text-right">60</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="imageFields" class="hidden">
                    <div class="space-y-4">
                        <div>
                            <label class="label">Position de l'image</label>
                            <select name="image_position" id="imagePosition" class="input-field" onchange="updateLivePreview()">
                                <optgroup label="Positions linéaires">
                                    <option value="header">Haut (Header)</option>
                                    <option value="body">Centre (Body)</option>
                                    <option value="footer">Bas (Footer)</option>
                                </optgroup>
                                <optgroup label="Coins">
                                    <option value="top_left">Coin Haut-Gauche</option>
                                    <option value="top_right" selected>Coin Haut-Droite</option>
                                    <option value="bottom_left">Coin Bas-Gauche</option>
                                    <option value="bottom_right">Coin Bas-Droite</option>
                                </optgroup>
                                <optgroup label="Position libre">
                                    <option value="custom">Position personnalisée</option>
                                </optgroup>
                            </select>
                        </div>

                        <div>
                            <label class="label">Image à afficher</label>
                            <div class="border-2 border-dashed border-gray-300 rounded-xl p-4 text-center hover:border-emerald-400 transition cursor-pointer" onclick="document.getElementById('imageFile').click()">
                                <input type="file" name="image_file" id="imageFile" accept="image/*" class="hidden" onchange="previewImage(event)">
                                <div id="imageUploadPlaceholder">
                                    <i class="fas fa-cloud-upload-alt text-gray-400 text-2xl mb-2"></i>
                                    <p class="text-sm text-gray-500">Cliquez pour sélectionner une image</p>
                                    <p class="text-xs text-gray-400 mt-1">JPG, PNG, GIF (max 5MB)</p>
                                </div>
                                <div id="imagePreviewContainer" class="hidden">
                                    <img id="uploadedImagePreview" class="max-h-24 mx-auto rounded">
                                    <p id="imageDimensions" class="text-xs text-gray-500 mt-2"></p>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="label">Taille sur l'écran</label>
                            <div class="flex items-center gap-3">
                                <input type="range" name="image_width_percent" id="imageSize" min="5" max="300" value="20" 
                                    class="flex-1" oninput="updateImageSizeLabel(); updateLivePreview();">
                                <span id="imageSizeLabel" class="text-sm font-mono w-14 text-right">20%</span>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Pourcentage de la largeur de l'écran (jusqu'à 300%)</p>
                        </div>

                        <div id="customPositionFields" class="hidden">
                            <label class="label">Position personnalisée</label>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="text-xs text-gray-500">Position X (%)</label>
                                    <input type="range" name="image_pos_x" id="imagePosX" min="0" max="100" value="50" 
                                        class="w-full" oninput="updatePosLabels(); updateLivePreview();">
                                    <span id="posXLabel" class="text-xs font-mono">50%</span>
                                </div>
                                <div>
                                    <label class="text-xs text-gray-500">Position Y (%)</label>
                                    <input type="range" name="image_pos_y" id="imagePosY" min="0" max="100" value="50" 
                                        class="w-full" oninput="updatePosLabels(); updateLivePreview();">
                                    <span id="posYLabel" class="text-xs font-mono">50%</span>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="label">Opacité</label>
                            <div class="flex items-center gap-3">
                                <input type="range" name="image_opacity" id="imageOpacity" min="0.1" max="1" step="0.1" value="1" 
                                    class="flex-1" oninput="updateOpacityLabel(); updateLivePreview();">
                                <span id="opacityLabel" class="text-sm font-mono w-14 text-right">100%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="border-t border-gray-100 pt-4">
                    <h4 class="font-medium text-gray-800 mb-3 text-sm flex items-center gap-2">
                        <i class="fas fa-calendar-alt text-emerald-500"></i>
                        Période d'affichage
                    </h4>
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <div>
                            <label class="label">Date de début</label>
                            <input type="datetime-local" name="start_time" class="input-field text-sm">
                            <p class="text-xs text-gray-400 mt-1">Laisser vide = immédiat</p>
                        </div>
                        <div>
                            <label class="label">Date de fin</label>
                            <input type="datetime-local" name="end_time" class="input-field text-sm">
                            <p class="text-xs text-gray-400 mt-1">Laisser vide = sans limite</p>
                        </div>
                    </div>
                    
                    <h4 class="font-medium text-gray-800 mb-3 text-sm flex items-center gap-2">
                        <i class="fas fa-repeat text-blue-500"></i>
                        Fréquence d'affichage
                    </h4>
                    
                    <div class="mb-4">
                        <label class="label">Type de fréquence</label>
                        <div class="grid grid-cols-2 gap-3">
                            <label class="relative cursor-pointer">
                                <input type="radio" name="frequency_type" value="duration" checked class="peer sr-only" onchange="switchFrequencyType('duration')">
                                <div class="p-3 border-2 border-gray-200 rounded-xl peer-checked:border-blue-500 peer-checked:bg-blue-50 transition">
                                    <div class="flex items-center gap-2">
                                        <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-clock text-blue-600 text-sm"></i>
                                        </div>
                                        <div>
                                            <p class="font-medium text-gray-800 text-sm">Par durée</p>
                                            <p class="text-xs text-gray-500">Temps d'affichage</p>
                                        </div>
                                    </div>
                                </div>
                            </label>
                            <label class="relative cursor-pointer">
                                <input type="radio" name="frequency_type" value="passage" class="peer sr-only" onchange="switchFrequencyType('passage')">
                                <div class="p-3 border-2 border-gray-200 rounded-xl peer-checked:border-purple-500 peer-checked:bg-purple-50 transition">
                                    <div class="flex items-center gap-2">
                                        <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-hashtag text-purple-600 text-sm"></i>
                                        </div>
                                        <div>
                                            <p class="font-medium text-gray-800 text-sm">Par passages</p>
                                            <p class="text-xs text-gray-500">Nombre de fois</p>
                                        </div>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <div id="durationFields">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="label">Durée d'affichage (sec)</label>
                                <input type="number" name="display_duration" id="displayDuration" value="10" min="1" max="300" class="input-field">
                                <p class="text-xs text-gray-400 mt-1">Temps visible par cycle</p>
                            </div>
                            <div>
                                <label class="label">Cycle</label>
                                <select name="frequency_unit" id="frequencyUnitDuration" class="input-field">
                                    <option value="morning">Matin (6h-12h)</option>
                                    <option value="noon">Midi (12h-14h)</option>
                                    <option value="afternoon">Après-midi (14h-18h)</option>
                                    <option value="evening">Soir (18h-22h)</option>
                                    <option value="night">Nuit (22h-6h)</option>
                                    <option value="day" selected>Jour</option>
                                    <option value="week">Semaine</option>
                                </select>
                                <p class="text-xs text-gray-400 mt-1">Par période choisie</p>
                            </div>
                        </div>
                    </div>

                    <div id="passageFields" class="hidden">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="label">Nombre de passages</label>
                                <input type="number" name="passage_limit" id="passageLimit" value="10" min="1" class="input-field">
                                <p class="text-xs text-gray-400 mt-1">Fois par cycle</p>
                            </div>
                            <div>
                                <label class="label">Cycle</label>
                                <select id="frequencyUnitPassage" class="input-field" onchange="syncFrequencyUnit()">
                                    <option value="morning">Matin (6h-12h)</option>
                                    <option value="noon">Midi (12h-14h)</option>
                                    <option value="afternoon">Après-midi (14h-18h)</option>
                                    <option value="evening">Soir (18h-22h)</option>
                                    <option value="night">Nuit (22h-6h)</option>
                                    <option value="day" selected>Jour</option>
                                    <option value="week">Semaine</option>
                                </select>
                                <p class="text-xs text-gray-400 mt-1">Réinitialisation du compteur</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex items-center gap-3">
                    <input type="checkbox" name="is_active" id="is_active" checked class="w-4 h-4 text-emerald-600 rounded border-gray-300">
                    <label for="is_active" class="text-sm text-gray-700">Activer immédiatement</label>
                </div>

                <button type="submit" class="btn-primary w-full justify-center">
                    <i class="fas fa-plus mr-2"></i>
                    Ajouter l'overlay
                </button>
            </form>
        </div>
    </div>

    <div class="space-y-4 sm:space-y-6">
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 sm:p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-semibold text-gray-800">Aperçu en temps réel</h3>
                <div class="flex items-center gap-2">
                    <button type="button" id="playPauseBtn" onclick="togglePreviewAnimation()" class="p-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition" title="Play/Pause">
                        <i class="fas fa-pause text-gray-600" id="playPauseIcon"></i>
                    </button>
                    <button type="button" onclick="resetPreview()" class="p-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition" title="Réinitialiser">
                        <i class="fas fa-redo text-gray-600"></i>
                    </button>
                </div>
            </div>
            
            <div class="relative bg-gray-900 rounded-xl overflow-hidden shadow-lg" 
                 id="livePreviewScreen"
                 style="aspect-ratio: {{ screen.resolution_width }}/{{ screen.resolution_height }};">
                <div class="absolute inset-0 flex items-center justify-center">
                    <div class="text-center text-gray-600">
                        <i class="fas fa-tv text-4xl mb-2 opacity-30"></i>
                        <p class="text-sm opacity-50">Contenu principal</p>
                    </div>
                </div>
                
                <div id="livePreviewHeader" class="absolute top-0 left-0 right-0 overflow-hidden"></div>
                <div id="livePreviewBody" class="absolute inset-0 flex items-center justify-center pointer-events-none"></div>
                <div id="livePreviewFooter" class="absolute bottom-0 left-0 right-0 overflow-hidden"></div>
                
                <div id="livePreviewTopLeft" class="absolute top-2 left-2"></div>
                <div id="livePreviewTopRight" class="absolute top-2 right-2"></div>
                <div id="livePreviewBottomLeft" class="absolute bottom-2 left-2"></div>
                <div id="livePreviewBottomRight" class="absolute bottom-2 right-2"></div>
                <div id="livePreviewCustom" class="absolute" style="display: none;"></div>
            </div>
            
            <div class="flex items-center justify-center gap-4 mt-3 text-xs text-gray-500">
                <span class="flex items-center gap-1">
                    <i class="fas fa-expand-arrows-alt"></i>
                    {{ screen.resolution_width }}x{{ screen.resolution_height }}
                </span>
                <span class="flex items-center gap-1">
                    <i class="fas fa-mobile-alt"></i>
                    {{ screen.orientation|capitalize }}
                </span>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 sm:p-6">
            <h3 class="font-semibold text-gray-800 mb-4">Overlays existants ({{ overlays|length }})</h3>
            
            {% if overlays %}
            <div class="space-y-3 max-h-96 overflow-y-auto">
                {% for overlay in overlays %}
                <div class="border border-gray-200 rounded-lg p-3 
                    {% if overlay.is_paused %}bg-yellow-50 border-yellow-200
                    {% elif overlay.is_active %}bg-green-50 border-green-200
                    {% endif %}
                    {% if overlay.source == 'broadcast' %}ring-2 ring-purple-300{% endif %}">
                    <div class="flex items-start justify-between gap-2">
                        <div class="flex items-start gap-3 min-w-0 flex-1">
                            <div class="w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0 {% if overlay.overlay_type == 'ticker' %}bg-blue-100 text-blue-600{% else %}bg-purple-100 text-purple-600{% endif %}">
                                <i class="fas {% if overlay.overlay_type == 'ticker' %}fa-align-left{% else %}fa-image{% endif %} text-sm"></i>
                            </div>
                            <div class="min-w-0">
                                <div class="flex items-center gap-2 flex-wrap mb-1">
                                    <span class="font-medium text-gray-800 text-sm">
                                        {% if overlay.overlay_type == 'ticker' %}Bandeau{% else %}Image{% endif %}
                                    </span>
                                    {% if overlay.is_paused %}
                                    <span class="px-1.5 py-0.5 text-xs rounded bg-yellow-100 text-yellow-700">
                                        <i class="fas fa-pause-circle mr-1"></i>En pause
                                    </span>
                                    {% elif overlay.is_active %}
                                    <span class="px-1.5 py-0.5 text-xs rounded bg-green-100 text-green-700">Actif</span>
                                    {% else %}
                                    <span class="px-1.5 py-0.5 text-xs rounded bg-gray-100 text-gray-600">Inactif</span>
                                    {% endif %}
                                    {% if overlay.source == 'broadcast' %}
                                    <span class="px-1.5 py-0.5 text-xs rounded bg-purple-100 text-purple-700">
                                        <i class="fas fa-broadcast-tower mr-1"></i>Diffusion
                                    </span>
                                    {% endif %}
                                    <span class="px-1.5 py-0.5 text-xs bg-gray-100 text-gray-600 rounded capitalize">{{ overlay.position }}</span>
                                    <span class="px-1.5 py-0.5 text-xs bg-blue-50 text-blue-600 rounded" title="Priorité">
                                        <i class="fas fa-sort-amount-up mr-1"></i>{{ overlay.priority }}
                                    </span>
                                </div>
                                {% if overlay.overlay_type == 'ticker' and overlay.message %}
                                <p class="text-gray-600 text-xs truncate">{{ overlay.message[:50] }}{% if overlay.message|length > 50 %}...{% endif %}</p>
                                {% elif overlay.overlay_type == 'image' and overlay.image_path %}
                                <img src="/{{ overlay.image_path }}" alt="Overlay" class="max-h-12 rounded mt-1">
                                {% endif %}
                            </div>
                        </div>
                        <div class="flex items-center gap-1 flex-shrink-0">
                            {% if overlay.is_paused %}
                            <form action="{{ url_for('org.resume_overlay', screen_id=screen.id, overlay_id=overlay.id) }}" method="POST">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="p-1.5 text-yellow-600 hover:text-green-600 transition" title="Reprendre">
                                    <i class="fas fa-play text-sm"></i>
                                </button>
                            </form>
                            {% else %}
                            <form action="{{ url_for('org.pause_overlay', screen_id=screen.id, overlay_id=overlay.id) }}" method="POST">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="p-1.5 text-gray-500 hover:text-yellow-600 transition" title="Mettre en pause">
                                    <i class="fas fa-pause text-sm"></i>
                                </button>
                            </form>
                            {% endif %}
                            <form action="{{ url_for('org.toggle_overlay', screen_id=screen.id, overlay_id=overlay.id) }}" method="POST">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="p-1.5 text-gray-500 hover:text-emerald-600 transition" title="{% if overlay.is_active %}Désactiver{% else %}Activer{% endif %}">
                                    <i class="fas {% if overlay.is_active %}fa-toggle-on text-green-500{% else %}fa-toggle-off{% endif %} text-sm"></i>
                                </button>
                            </form>
                            <form action="{{ url_for('org.delete_overlay', screen_id=screen.id, overlay_id=overlay.id) }}" method="POST" onsubmit="return confirm('Supprimer cet overlay ?')">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="p-1.5 text-gray-500 hover:text-red-600 transition" title="Supprimer">
                                    <i class="fas fa-trash text-sm"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-6">
                <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-layer-group text-gray-400 text-lg"></i>
                </div>
                <p class="text-gray-500 text-sm">Aucun overlay configuré</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
const screenWidth = {{ screen.resolution_width }};
const screenHeight = {{ screen.resolution_height }};
let animationPaused = false;
let tickerAnimation = null;
let uploadedImageSrc = null;

function switchOverlayType(type) {
    document.getElementById('tickerFields').classList.toggle('hidden', type !== 'ticker');
    document.getElementById('imageFields').classList.toggle('hidden', type !== 'image');
    clearAllPreviews();
    updateLivePreview();
}

function switchFrequencyType(type) {
    document.getElementById('durationFields').classList.toggle('hidden', type !== 'duration');
    document.getElementById('passageFields').classList.toggle('hidden', type !== 'passage');
    syncFrequencyUnit();
}

function syncFrequencyUnit() {
    const frequencyType = document.querySelector('input[name="frequency_type"]:checked').value;
    const durationSelect = document.getElementById('frequencyUnitDuration');
    const passageSelect = document.getElementById('frequencyUnitPassage');
    
    if (frequencyType === 'passage') {
        durationSelect.value = passageSelect.value;
    }
}

function clearAllPreviews() {
    ['livePreviewHeader', 'livePreviewFooter', 'livePreviewBody', 
     'livePreviewTopLeft', 'livePreviewTopRight', 'livePreviewBottomLeft', 
     'livePreviewBottomRight', 'livePreviewCustom'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.innerHTML = '';
            el.style.display = id === 'livePreviewCustom' ? 'none' : '';
        }
    });
}

function updateFontSizeLabel() {
    document.getElementById('fontSizeLabel').textContent = document.getElementById('fontSize').value + 'px';
}

function updateSpeedLabel() {
    document.getElementById('speedLabel').textContent = document.getElementById('scrollSpeed').value;
}

function updateImageSizeLabel() {
    document.getElementById('imageSizeLabel').textContent = document.getElementById('imageSize').value + '%';
}

function updateOpacityLabel() {
    const val = Math.round(document.getElementById('imageOpacity').value * 100);
    document.getElementById('opacityLabel').textContent = val + '%';
}

function updatePosLabels() {
    document.getElementById('posXLabel').textContent = document.getElementById('imagePosX').value + '%';
    document.getElementById('posYLabel').textContent = document.getElementById('imagePosY').value + '%';
}

function previewImage(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            uploadedImageSrc = e.target.result;
            document.getElementById('uploadedImagePreview').src = uploadedImageSrc;
            document.getElementById('imageUploadPlaceholder').classList.add('hidden');
            document.getElementById('imagePreviewContainer').classList.remove('hidden');
            
            const img = new Image();
            img.onload = function() {
                document.getElementById('imageDimensions').textContent = `${img.width} x ${img.height} pixels`;
            };
            img.src = uploadedImageSrc;
            
            updateLivePreview();
        };
        reader.readAsDataURL(file);
    }
}

function getSelectedOverlayType() {
    return document.querySelector('input[name="overlay_type"]:checked').value;
}

function getSelectedPosition() {
    const type = getSelectedOverlayType();
    if (type === 'ticker') {
        const checked = document.querySelector('input[name="position"]:checked');
        return checked ? checked.value : 'footer';
    } else {
        return document.getElementById('imagePosition').value;
    }
}

function updateLivePreview() {
    clearAllPreviews();
    
    const type = getSelectedOverlayType();
    const position = getSelectedPosition();
    
    if (type === 'ticker') {
        updateTickerPreview(position);
    } else {
        updateImagePreview(position);
    }
    
    const customFields = document.getElementById('customPositionFields');
    if (customFields) {
        customFields.classList.toggle('hidden', position !== 'custom');
    }
}

function updateTickerPreview(position) {
    const message = document.getElementById('tickerMessage').value || 'Votre message défilant apparaîtra ici...';
    const bgColor = document.getElementById('bgColor').value;
    const textColor = document.getElementById('textColor').value;
    const fontSize = document.getElementById('fontSize').value;
    const speed = document.getElementById('scrollSpeed').value;
    
    let targetId;
    if (position === 'header') targetId = 'livePreviewHeader';
    else if (position === 'footer') targetId = 'livePreviewFooter';
    else targetId = 'livePreviewBody';
    
    const target = document.getElementById(targetId);
    if (!target) return;
    
    const previewFontSize = Math.max(10, Math.min(fontSize * 0.4, 18));
    const animationDuration = Math.max(3, 30 - (speed / 5));
    
    target.innerHTML = `
        <div class="w-full overflow-hidden" style="background: ${bgColor};">
            <div class="ticker-text whitespace-nowrap" style="color: ${textColor}; font-size: ${previewFontSize}px; padding: 6px 0; animation: tickerScroll ${animationDuration}s linear infinite ${animationPaused ? 'paused' : 'running'};">
                ${message} &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ${message} &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ${message}
            </div>
        </div>
    `;
    
    document.getElementById('bgColorText').value = bgColor;
    document.getElementById('textColorText').value = textColor;
}

function updateImagePreview(position) {
    if (!uploadedImageSrc) {
        const placeholderPositions = {
            'header': 'livePreviewHeader',
            'body': 'livePreviewBody',
            'footer': 'livePreviewFooter',
            'top_left': 'livePreviewTopLeft',
            'top_right': 'livePreviewTopRight',
            'bottom_left': 'livePreviewBottomLeft',
            'bottom_right': 'livePreviewBottomRight',
            'custom': 'livePreviewCustom'
        };
        
        const targetId = placeholderPositions[position];
        const target = document.getElementById(targetId);
        if (target) {
            const size = document.getElementById('imageSize').value;
            target.innerHTML = `
                <div style="width: ${size * 2}px; height: ${size * 1.5}px; background: rgba(255,255,255,0.1); border: 2px dashed rgba(255,255,255,0.4); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-image text-white/40 text-lg"></i>
                </div>
            `;
            if (position === 'custom') {
                target.style.display = 'block';
                const posX = document.getElementById('imagePosX').value;
                const posY = document.getElementById('imagePosY').value;
                target.style.left = `${posX}%`;
                target.style.top = `${posY}%`;
                target.style.transform = 'translate(-50%, -50%)';
            }
        }
        return;
    }
    
    const sizePercent = document.getElementById('imageSize').value;
    const opacity = document.getElementById('imageOpacity').value;
    
    const positionMap = {
        'header': 'livePreviewHeader',
        'body': 'livePreviewBody',
        'footer': 'livePreviewFooter',
        'top_left': 'livePreviewTopLeft',
        'top_right': 'livePreviewTopRight',
        'bottom_left': 'livePreviewBottomLeft',
        'bottom_right': 'livePreviewBottomRight',
        'custom': 'livePreviewCustom'
    };
    
    const targetId = positionMap[position];
    const target = document.getElementById(targetId);
    if (!target) return;
    
    const imgStyle = `max-width: ${sizePercent * 2}px; opacity: ${opacity}; border-radius: 4px;`;
    
    if (position === 'custom') {
        const posX = document.getElementById('imagePosX').value;
        const posY = document.getElementById('imagePosY').value;
        target.style.display = 'block';
        target.style.left = `${posX}%`;
        target.style.top = `${posY}%`;
        target.style.transform = 'translate(-50%, -50%)';
        target.innerHTML = `<img src="${uploadedImageSrc}" style="${imgStyle}">`;
    } else if (['header', 'body', 'footer'].includes(position)) {
        target.innerHTML = `<div class="flex justify-center p-2"><img src="${uploadedImageSrc}" style="${imgStyle}"></div>`;
    } else {
        target.innerHTML = `<img src="${uploadedImageSrc}" style="${imgStyle}">`;
    }
}

function togglePreviewAnimation() {
    animationPaused = !animationPaused;
    const icon = document.getElementById('playPauseIcon');
    icon.classList.toggle('fa-pause', !animationPaused);
    icon.classList.toggle('fa-play', animationPaused);
    
    document.querySelectorAll('.ticker-text').forEach(el => {
        el.style.animationPlayState = animationPaused ? 'paused' : 'running';
    });
}

function resetPreview() {
    animationPaused = false;
    document.getElementById('playPauseIcon').classList.remove('fa-play');
    document.getElementById('playPauseIcon').classList.add('fa-pause');
    updateLivePreview();
}

function updateFrequencyVisibility() {
    const passageLimit = parseInt(document.getElementById('passageLimit').value) || 0;
    const container = document.getElementById('frequencyUnitContainer');
    if (container) {
        container.style.display = passageLimit > 0 ? 'block' : 'none';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    updateLivePreview();
    updateFrequencyVisibility();
    
    document.getElementById('imagePosition').addEventListener('change', function() {
        updateLivePreview();
    });
    
    document.getElementById('passageLimit').addEventListener('input', updateFrequencyVisibility);
});
</script>

<style>
@keyframes tickerScroll {
    0% { transform: translateX(100%); }
    100% { transform: translateX(-100%); }
}

.ticker-text {
    display: inline-block;
    padding-left: 100%;
}

input[type="range"] {
    -webkit-appearance: none;
    height: 6px;
    background: #e5e7eb;
    border-radius: 5px;
    outline: none;
}

input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 16px;
    height: 16px;
    background: #10b981;
    border-radius: 50%;
    cursor: pointer;
}

input[type="range"]::-moz-range-thumb {
    width: 16px;
    height: 16px;
    background: #10b981;
    border-radius: 50%;
    cursor: pointer;
    border: none;
}
</style>
{% endblock %}
