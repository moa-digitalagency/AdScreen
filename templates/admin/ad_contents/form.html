{% extends "admin/base.html" %}

{% block page_title %}{% if ad %}Modifier{% else %}Nouveau{% endif %} Contenu Pub{% endblock %}

{% block main_content %}
<div class="max-w-4xl mx-auto space-y-6">
    <div class="flex items-center gap-4">
        <a href="{{ url_for('ad_content.list') }}" class="p-2 text-gray-400 hover:text-gray-600 transition">
            <i class="fas fa-arrow-left"></i>
        </a>
        <div>
            <h2 class="text-xl sm:text-2xl font-bold text-gray-900">
                {% if ad %}Modifier le contenu{% else %}Nouveau contenu publicitaire{% endif %}
            </h2>
            <p class="text-gray-600 mt-1">
                {% if ad %}Référence: {{ ad.reference }}{% else %}Créez un contenu pour l'afficher sur les écrans partenaires{% endif %}
            </p>
        </div>
    </div>

    <form method="POST" enctype="multipart/form-data" class="space-y-6">
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-info-circle text-primary-500 mr-2"></i>
                Informations générales
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nom du contenu *</label>
                    <input type="text" name="name" value="{{ ad.name if ad else '' }}" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                           placeholder="Ex: Campagne été 2024">
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea name="description" rows="3"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                              placeholder="Description du contenu...">{{ ad.description if ad else '' }}</textarea>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-crosshairs text-blue-500 mr-2"></i>
                Ciblage
            </h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Type de ciblage</label>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <label class="relative cursor-pointer">
                            <input type="radio" name="target_type" value="country" class="peer sr-only" 
                                   {% if not ad or ad.target_type == 'country' %}checked{% endif %}>
                            <div class="p-3 border-2 border-gray-200 rounded-lg text-center peer-checked:border-primary-500 peer-checked:bg-primary-50 transition">
                                <i class="fas fa-globe text-xl text-gray-400 peer-checked:text-primary-500 mb-1"></i>
                                <p class="text-sm font-medium">Pays</p>
                            </div>
                        </label>
                        <label class="relative cursor-pointer">
                            <input type="radio" name="target_type" value="city" class="peer sr-only"
                                   {% if ad and ad.target_type == 'city' %}checked{% endif %}>
                            <div class="p-3 border-2 border-gray-200 rounded-lg text-center peer-checked:border-primary-500 peer-checked:bg-primary-50 transition">
                                <i class="fas fa-city text-xl text-gray-400 peer-checked:text-primary-500 mb-1"></i>
                                <p class="text-sm font-medium">Ville</p>
                            </div>
                        </label>
                        <label class="relative cursor-pointer">
                            <input type="radio" name="target_type" value="organization" class="peer sr-only"
                                   {% if ad and ad.target_type == 'organization' %}checked{% endif %}>
                            <div class="p-3 border-2 border-gray-200 rounded-lg text-center peer-checked:border-primary-500 peer-checked:bg-primary-50 transition">
                                <i class="fas fa-building text-xl text-gray-400 peer-checked:text-primary-500 mb-1"></i>
                                <p class="text-sm font-medium">Établissement</p>
                            </div>
                        </label>
                        <label class="relative cursor-pointer">
                            <input type="radio" name="target_type" value="screen" class="peer sr-only"
                                   {% if ad and ad.target_type == 'screen' %}checked{% endif %}>
                            <div class="p-3 border-2 border-gray-200 rounded-lg text-center peer-checked:border-primary-500 peer-checked:bg-primary-50 transition">
                                <i class="fas fa-tv text-xl text-gray-400 peer-checked:text-primary-500 mb-1"></i>
                                <p class="text-sm font-medium">Écran</p>
                            </div>
                        </label>
                    </div>
                </div>

                <div id="target-country-section" class="target-section">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Pays</label>
                    <select name="target_country" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                        {% for code, name in countries %}
                        <option value="{{ code }}" {% if ad and ad.target_country == code %}selected{% endif %}>{{ name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div id="target-city-section" class="target-section hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Pays</label>
                            <select name="target_country_city" id="country-for-city" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                                {% for code, name in countries %}
                                <option value="{{ code }}" {% if ad and ad.target_country == code %}selected{% endif %}>{{ name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Ville</label>
                            <select name="target_city" id="city-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                                <option value="">Sélectionner une ville</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="target-organization-section" class="target-section hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Établissement</label>
                    <select name="target_organization_id" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                        <option value="">Sélectionner un établissement</option>
                        {% for org in organizations %}
                        <option value="{{ org.id }}" {% if ad and ad.target_organization_id == org.id %}selected{% endif %}>{{ org.name }} ({{ org.city or 'N/A' }})</option>
                        {% endfor %}
                    </select>
                </div>

                <div id="target-screen-section" class="target-section hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Écran</label>
                    <select name="target_screen_id" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                        <option value="">Sélectionner un écran</option>
                        {% for screen in screens %}
                        <option value="{{ screen.id }}" {% if ad and ad.target_screen_id == screen.id %}selected{% endif %}>{{ screen.name }} - {{ screen.organization.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Type d'établissements</label>
                    <div class="flex flex-wrap gap-3">
                        <label class="inline-flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="target_org_type" value="all" class="form-radio text-primary-500"
                                   {% if not ad or ad.target_org_type == 'all' %}checked{% endif %}>
                            <span class="text-sm">Tous</span>
                        </label>
                        <label class="inline-flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="target_org_type" value="paid" class="form-radio text-primary-500"
                                   {% if ad and ad.target_org_type == 'paid' %}checked{% endif %}>
                            <span class="text-sm">Payants uniquement</span>
                        </label>
                        <label class="inline-flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="target_org_type" value="free" class="form-radio text-primary-500"
                                   {% if ad and ad.target_org_type == 'free' %}checked{% endif %}>
                            <span class="text-sm">Gratuits uniquement</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-image text-purple-500 mr-2"></i>
                Contenu média
            </h3>
            <div class="space-y-4">
                {% if ad and ad.file_path %}
                <div class="flex items-center gap-4 p-4 bg-gray-50 rounded-lg">
                    <div class="w-24 h-24 rounded-lg overflow-hidden bg-gray-200">
                        {% if ad.content_type == 'video' %}
                        <video src="/{{ ad.file_path }}" class="w-full h-full object-cover"></video>
                        {% else %}
                        <img src="/{{ ad.file_path }}" alt="" class="w-full h-full object-cover">
                        {% endif %}
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Fichier actuel:</p>
                        <p class="font-medium text-gray-900">{{ ad.content_type|upper }} - {{ "%.2f"|format(ad.file_size / 1024 / 1024) }} Mo</p>
                    </div>
                </div>
                {% endif %}
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        {% if ad %}Remplacer le fichier{% else %}Fichier (image ou vidéo) *{% endif %}
                    </label>
                    <input type="file" name="content_file" accept="image/*,video/*"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                           {% if not ad %}required{% endif %}>
                    <p class="text-xs text-gray-500 mt-1">Formats acceptés: PNG, JPG, GIF, WEBP, MP4, WEBM, MOV</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Durée d'affichage (secondes)</label>
                    <input type="number" name="duration" value="{{ ad.duration if ad else 10 }}" min="5" max="120"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-user-tie text-orange-500 mr-2"></i>
                Annonceur
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nom de l'annonceur</label>
                    <input type="text" name="advertiser_name" value="{{ ad.advertiser_name if ad else '' }}"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                           placeholder="Nom du contact">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Entreprise</label>
                    <input type="text" name="advertiser_company" value="{{ ad.advertiser_company if ad else '' }}"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                           placeholder="Nom de l'entreprise">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" name="advertiser_email" value="{{ ad.advertiser_email if ad else '' }}"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                           placeholder="email@exemple.com">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Téléphone</label>
                    <input type="tel" name="advertiser_phone" value="{{ ad.advertiser_phone if ad else '' }}"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                           placeholder="+33 6 00 00 00 00">
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-euro-sign text-green-500 mr-2"></i>
                Tarification & Commission
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Prix total</label>
                    <input type="number" name="total_price" value="{{ ad.total_price if ad else 0 }}" min="0" step="0.01"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Devise</label>
                    <select name="currency" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                        <option value="EUR" {% if not ad or ad.currency == 'EUR' %}selected{% endif %}>EUR (€)</option>
                        <option value="MAD" {% if ad and ad.currency == 'MAD' %}selected{% endif %}>MAD (DH)</option>
                        <option value="XOF" {% if ad and ad.currency == 'XOF' %}selected{% endif %}>XOF (CFA)</option>
                        <option value="TND" {% if ad and ad.currency == 'TND' %}selected{% endif %}>TND (DT)</option>
                        <option value="USD" {% if ad and ad.currency == 'USD' %}selected{% endif %}>USD ($)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Commission établissements (%)</label>
                    <input type="number" name="commission_rate" value="{{ ad.commission_rate if ad else ad_settings.ad_commission_rate }}" min="0" max="100" step="0.1"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                    <p class="text-xs text-gray-500 mt-1">Pourcentage reversé aux établissements</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-calendar text-red-500 mr-2"></i>
                Programmation
            </h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Mode de diffusion</label>
                    <div class="flex flex-wrap gap-4">
                        <label class="inline-flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="schedule_type" value="immediate" class="form-radio text-primary-500"
                                   {% if not ad or ad.schedule_type == 'immediate' %}checked{% endif %}>
                            <span class="text-sm">Diffusion immédiate</span>
                        </label>
                        <label class="inline-flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="schedule_type" value="period" class="form-radio text-primary-500"
                                   {% if ad and ad.schedule_type == 'period' %}checked{% endif %}>
                            <span class="text-sm">Période programmée</span>
                        </label>
                    </div>
                </div>

                <div id="period-section" class="grid grid-cols-1 md:grid-cols-2 gap-4 {% if not ad or ad.schedule_type == 'immediate' %}hidden{% endif %}">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Date de début</label>
                        <input type="datetime-local" name="start_date" 
                               value="{{ ad.start_date.strftime('%Y-%m-%dT%H:%M') if ad and ad.start_date else '' }}"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Date de fin</label>
                        <input type="datetime-local" name="end_date"
                               value="{{ ad.end_date.strftime('%Y-%m-%dT%H:%M') if ad and ad.end_date else '' }}"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                    </div>
                </div>
            </div>
        </div>

        <div class="flex items-center justify-end gap-3">
            <a href="{{ url_for('ad_content.list') }}" class="btn-secondary">
                Annuler
            </a>
            <button type="submit" class="btn-primary">
                <i class="fas fa-save mr-2"></i>
                {% if ad %}Enregistrer{% else %}Créer le contenu{% endif %}
            </button>
        </div>
    </form>
</div>

<script>
const citiesByCountry = {{ cities_by_country|tojson|safe }};

document.addEventListener('DOMContentLoaded', function() {
    const targetTypeRadios = document.querySelectorAll('input[name="target_type"]');
    const scheduleTypeRadios = document.querySelectorAll('input[name="schedule_type"]');
    const countryForCity = document.getElementById('country-for-city');
    const citySelect = document.getElementById('city-select');

    function updateTargetSections() {
        const selectedType = document.querySelector('input[name="target_type"]:checked').value;
        document.querySelectorAll('.target-section').forEach(section => {
            section.classList.add('hidden');
        });
        document.getElementById(`target-${selectedType}-section`).classList.remove('hidden');
    }

    function updateCityOptions() {
        const country = countryForCity.value;
        const cities = citiesByCountry[country] || [];
        citySelect.innerHTML = '<option value="">Sélectionner une ville</option>';
        cities.forEach(city => {
            const option = document.createElement('option');
            option.value = city;
            option.textContent = city;
            citySelect.appendChild(option);
        });
        {% if ad and ad.target_city %}
        citySelect.value = '{{ ad.target_city }}';
        {% endif %}
    }

    function updateScheduleSection() {
        const isImmediate = document.querySelector('input[name="schedule_type"]:checked').value === 'immediate';
        document.getElementById('period-section').classList.toggle('hidden', isImmediate);
    }

    targetTypeRadios.forEach(radio => {
        radio.addEventListener('change', updateTargetSections);
    });

    scheduleTypeRadios.forEach(radio => {
        radio.addEventListener('change', updateScheduleSection);
    });

    countryForCity.addEventListener('change', updateCityOptions);

    updateTargetSections();
    updateCityOptions();
    updateScheduleSection();
});
</script>
{% endblock %}
