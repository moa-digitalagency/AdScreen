<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ screen.name }} - Shabaka AdScreen Player</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            overflow: hidden;
            cursor: none;
        }
        
        body.show-controls {
            cursor: default;
        }
        
        #player {
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            background: #000;
        }
        
        #player img,
        #player video {
            width: 100%;
            height: 100%;
            object-fit: contain;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        #controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 100;
            pointer-events: none;
        }
        
        body.show-controls #controls {
            opacity: 1;
            pointer-events: auto;
        }
        
        .control-btn {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-family: sans-serif;
            font-size: 14px;
            transition: background 0.2s;
        }
        
        .control-btn:hover {
            background: rgba(255,255,255,0.2);
        }
        
        #status {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(10px);
            padding: 8px 16px;
            border-radius: 20px;
            color: white;
            font-family: sans-serif;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        
        body.show-controls #status {
            opacity: 1;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .status-playing { background: #22c55e; }
        .status-paused { background: #eab308; }
        .status-offline { background: #ef4444; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        #info {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(10px);
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-family: sans-serif;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        
        body.show-controls #info {
            opacity: 1;
        }
        
        .overlay-header, .overlay-footer {
            position: fixed;
            left: 0;
            right: 0;
            z-index: 50;
            overflow: hidden;
        }
        
        .overlay-header { top: 0; }
        .overlay-footer { bottom: 0; }
        
        .overlay-ticker {
            white-space: nowrap;
            display: inline-block;
            padding: 12px 0;
            animation: ticker linear infinite;
        }
        
        @keyframes ticker {
            0% { transform: translateX(100vw); }
            100% { transform: translateX(-100%); }
        }
        
        .overlay-image {
            width: 100%;
            height: auto;
            object-fit: contain;
        }
        
        .overlay-body {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50;
        }
        
        #startScreen {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-family: sans-serif;
            z-index: 200;
        }
        
        #startScreen.hidden {
            display: none;
        }
        
        #startBtn {
            background: #3b82f6;
            border: none;
            color: white;
            padding: 20px 40px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 30px;
            transition: transform 0.2s, background 0.2s;
        }
        
        #startBtn:hover {
            background: #2563eb;
            transform: scale(1.05);
        }
        
        .loading {
            position: fixed;
            inset: 0;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 150;
        }
        
        .loading.hidden {
            display: none;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255,255,255,0.1);
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        #debugInfo {
            position: fixed;
            top: 60px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            color: #0f0;
            font-family: monospace;
            font-size: 10px;
            padding: 10px;
            border-radius: 4px;
            max-width: 300px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        
        body.show-controls #debugInfo {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div id="startScreen">
        <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="2" y="7" width="20" height="15" rx="2" ry="2"/>
            <polyline points="17,2 12,7 7,2"/>
        </svg>
        <h1 style="font-size: 28px; margin-top: 20px;">{{ screen.name }}</h1>
        <p style="color: rgba(255,255,255,0.6); margin-top: 8px;">{{ screen.resolution_width }}x{{ screen.resolution_height }} - {{ screen.orientation }}</p>
        <button id="startBtn" onclick="startPlayer()">
            ‚ñ∂ Lancer la playlist
        </button>
        <p style="color: rgba(255,255,255,0.4); margin-top: 30px; font-size: 12px;">
            Appuyez sur F11 pour le mode plein √©cran
        </p>
    </div>

    <div id="loading" class="loading hidden">
        <div class="spinner"></div>
    </div>

    <div id="overlayHeader" class="overlay-header" style="display: none;"></div>
    
    <div id="player">
        <img id="imageContent" style="display: none;" />
        <video id="videoContent" style="display: none;" muted playsinline></video>
    </div>
    
    <div id="overlayFooter" class="overlay-footer" style="display: none;"></div>

    <div id="status">
        <span class="status-dot status-playing" id="statusDot"></span>
        <span id="statusText">En ligne</span>
    </div>

    <div id="info">
        <div id="currentInfo">En attente...</div>
        <div id="nextInfo" style="color: rgba(255,255,255,0.5); margin-top: 4px;"></div>
    </div>

    <div id="debugInfo"></div>

    <div id="controls">
        <button class="control-btn" onclick="togglePause()">
            <span id="pauseIcon">‚è∏</span> Pause
        </button>
        <button class="control-btn" onclick="toggleFullscreen()">
            ‚õ∂ Plein √©cran
        </button>
        <button class="control-btn" onclick="logout()">
            ‚èª D√©connecter
        </button>
    </div>

    <script>
        const PlayerState = {
            IDLE: 'idle',
            PLAYING: 'playing',
            PAUSED: 'paused',
            TRANSITIONING: 'transitioning'
        };

        const player = {
            playlist: [],
            overlays: [],
            currentIndex: 0,
            state: PlayerState.IDLE,
            timerId: null,
            heartbeatInterval: null,
            refreshInterval: null,
            controlsTimeout: null,
            currentItemStartTime: null,
            
            CONTROLS_HIDE_DELAY: 10000,
            PLAYLIST_REFRESH_INTERVAL: 10000,
            MIN_DISPLAY_TIME: 1000,
            
            imageEl: null,
            videoEl: null,
            debugEl: null
        };

        function debug(msg) {
            console.log('[Player]', msg);
            if (player.debugEl) {
                const time = new Date().toLocaleTimeString();
                player.debugEl.innerHTML = `[${time}] ${msg}<br>` + 
                    (player.debugEl.innerHTML || '').split('<br>').slice(0, 10).join('<br>');
            }
        }

        function showControls() {
            document.body.classList.add('show-controls');
            clearTimeout(player.controlsTimeout);
            player.controlsTimeout = setTimeout(() => {
                document.body.classList.remove('show-controls');
            }, player.CONTROLS_HIDE_DELAY);
        }

        function clearTimer() {
            if (player.timerId) {
                clearTimeout(player.timerId);
                player.timerId = null;
            }
        }

        function scheduleNext(delayMs) {
            clearTimer();
            debug(`Scheduling next in ${delayMs}ms`);
            player.timerId = setTimeout(() => {
                advanceToNext();
            }, delayMs);
        }

        function advanceToNext() {
            if (player.state === PlayerState.PAUSED) {
                debug('Paused, not advancing');
                return;
            }
            
            if (player.playlist.length === 0) {
                debug('Empty playlist, waiting...');
                player.state = PlayerState.IDLE;
                updateInfoDisplay(null);
                return;
            }
            
            player.state = PlayerState.TRANSITIONING;
            clearTimer();
            
            player.currentIndex = (player.currentIndex + 1) % player.playlist.length;
            debug(`Advancing to index ${player.currentIndex} of ${player.playlist.length}`);
            
            playCurrentItem();
        }

        function playCurrentItem() {
            if (player.state === PlayerState.PAUSED) {
                debug('Paused, not playing');
                return;
            }
            
            if (player.playlist.length === 0) {
                debug('No items to play');
                player.state = PlayerState.IDLE;
                updateInfoDisplay(null);
                return;
            }
            
            const item = player.playlist[player.currentIndex];
            if (!item) {
                debug('Invalid item at index ' + player.currentIndex);
                player.currentIndex = 0;
                if (player.playlist.length > 0) {
                    setTimeout(() => playCurrentItem(), 100);
                }
                return;
            }
            
            player.state = PlayerState.PLAYING;
            player.currentItemStartTime = Date.now();
            
            const duration = Math.max(3, parseInt(item.duration) || 10);
            debug(`Playing: ${item.category}/${item.name || item.id} for ${duration}s`);
            
            updateInfoDisplay(item);
            
            if (item.type === 'image') {
                playImage(item, duration);
            } else if (item.type === 'video') {
                playVideo(item, duration);
            } else {
                debug('Unknown content type: ' + item.type);
                scheduleNext(1000);
            }
        }

        function playImage(item, duration) {
            player.videoEl.pause();
            player.videoEl.removeAttribute('src');
            player.videoEl.style.display = 'none';
            
            player.imageEl.style.display = 'block';
            player.imageEl.src = item.url;
            
            player.imageEl.onload = () => {
                debug('Image loaded: ' + item.url);
                logPlay(item);
            };
            
            player.imageEl.onerror = () => {
                debug('Image error: ' + item.url);
                scheduleNext(500);
            };
            
            scheduleNext(duration * 1000);
        }

        function playVideo(item, duration) {
            player.imageEl.style.display = 'none';
            
            player.videoEl.onended = null;
            player.videoEl.onerror = null;
            player.videoEl.onloadeddata = null;
            player.videoEl.ontimeupdate = null;
            
            player.videoEl.style.display = 'block';
            player.videoEl.src = item.url;
            player.videoEl.currentTime = 0;
            player.videoEl.loop = false;
            
            let hasLogged = false;
            let hasEnded = false;
            
            const handleVideoEnd = () => {
                if (hasEnded) return;
                hasEnded = true;
                debug('Video ended naturally');
                clearTimer();
                advanceToNext();
            };
            
            player.videoEl.onloadeddata = () => {
                debug('Video loaded, duration: ' + player.videoEl.duration);
                player.videoEl.play().then(() => {
                    if (!hasLogged) {
                        hasLogged = true;
                        logPlay(item);
                    }
                }).catch(e => {
                    debug('Video play error: ' + e.message);
                    scheduleNext(500);
                });
            };
            
            player.videoEl.onended = handleVideoEnd;
            
            player.videoEl.onerror = (e) => {
                debug('Video error: ' + (e.message || 'unknown'));
                if (!hasEnded) {
                    hasEnded = true;
                    scheduleNext(500);
                }
            };
            
            player.videoEl.ontimeupdate = () => {
                if (!hasEnded && player.videoEl.currentTime >= player.videoEl.duration - 0.1) {
                    handleVideoEnd();
                }
            };
            
            const maxDuration = Math.max(duration, 5) * 1000 + 3000;
            scheduleNext(maxDuration);
        }

        function updateInfoDisplay(item) {
            const currentInfoEl = document.getElementById('currentInfo');
            const nextInfoEl = document.getElementById('nextInfo');
            
            if (!item) {
                currentInfoEl.textContent = 'Aucun contenu disponible';
                nextInfoEl.textContent = 'En attente de nouveaux contenus...';
                return;
            }
            
            const categoryLabels = {
                'paid': 'üí∞ Publicit√©',
                'internal': 'üì¢ Promo',
                'filler': 'üé¨ D√©mo'
            };
            
            const itemName = item.name || 'Contenu';
            currentInfoEl.innerHTML = 
                `<strong>${categoryLabels[item.category] || item.category}</strong> - ${itemName}<br>
                 <span style="opacity: 0.7">Dur√©e: ${item.duration}s ${item.remaining_plays ? `| Restant: ${item.remaining_plays}` : ''}</span>`;
            
            if (player.playlist.length > 1) {
                const nextIndex = (player.currentIndex + 1) % player.playlist.length;
                const nextItem = player.playlist[nextIndex];
                nextInfoEl.textContent = 
                    `Suivant: ${categoryLabels[nextItem.category] || nextItem.category} - ${nextItem.name || 'Contenu'}`;
            } else {
                nextInfoEl.textContent = 'Boucle en cours...';
            }
        }

        async function fetchPlaylist() {
            try {
                const response = await fetch('/player/api/playlist');
                const data = await response.json();
                
                if (data.error) {
                    debug('Playlist error: ' + data.error);
                    return;
                }
                
                const newPlaylist = data.playlist || [];
                player.overlays = data.overlays || [];
                
                if (player.playlist.length !== newPlaylist.length) {
                    debug(`Playlist updated: ${player.playlist.length} -> ${newPlaylist.length} items`);
                }
                
                if (player.currentIndex >= newPlaylist.length && newPlaylist.length > 0) {
                    player.currentIndex = 0;
                }
                
                player.playlist = newPlaylist;
                renderOverlays();
                
                if (player.state === PlayerState.IDLE && player.playlist.length > 0) {
                    debug('Starting playback from idle');
                    player.currentIndex = 0;
                    playCurrentItem();
                }
                
                if (player.playlist.length === 0) {
                    updateInfoDisplay(null);
                }
            } catch (error) {
                debug('Fetch playlist error: ' + error.message);
            }
        }

        async function logPlay(item) {
            try {
                const response = await fetch('/player/api/log-play', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content_id: item.id,
                        content_type: item.type,
                        category: item.category,
                        duration: item.duration,
                        booking_id: item.booking_id
                    })
                });
                
                const result = await response.json();
                if (result.exhausted) {
                    debug('Content exhausted, refreshing playlist');
                    fetchPlaylist();
                }
            } catch (error) {
                debug('Log play error: ' + error.message);
            }
        }

        async function sendHeartbeat() {
            const status = player.state === PlayerState.PAUSED ? 'paused' : 'playing';
            try {
                await fetch('/player/api/heartbeat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                });
                
                document.getElementById('statusDot').className = 'status-dot status-' + status;
                document.getElementById('statusText').textContent = 
                    player.state === PlayerState.PAUSED ? 'En pause' : 'En lecture';
            } catch (error) {
                document.getElementById('statusDot').className = 'status-dot status-offline';
                document.getElementById('statusText').textContent = 'Hors ligne';
            }
        }

        function togglePause() {
            if (player.state === PlayerState.PAUSED) {
                debug('Resuming playback');
                player.state = PlayerState.PLAYING;
                document.getElementById('pauseIcon').textContent = '‚è∏';
                
                if (player.playlist.length > 0) {
                    playCurrentItem();
                }
            } else {
                debug('Pausing playback');
                player.state = PlayerState.PAUSED;
                document.getElementById('pauseIcon').textContent = '‚ñ∂';
                
                clearTimer();
                player.videoEl.pause();
            }
            
            sendHeartbeat();
        }

        function renderOverlays() {
            const headerEl = document.getElementById('overlayHeader');
            const footerEl = document.getElementById('overlayFooter');
            
            headerEl.style.display = 'none';
            footerEl.style.display = 'none';
            headerEl.innerHTML = '';
            footerEl.innerHTML = '';
            
            (player.overlays || []).forEach(overlay => {
                if (!overlay.is_active) return;
                
                const container = overlay.position === 'header' ? headerEl : footerEl;
                container.style.display = 'block';
                container.style.backgroundColor = overlay.background_color || '#000000';
                
                if (overlay.type === 'ticker') {
                    const duration = Math.max(10, (overlay.message?.length || 50) / (overlay.scroll_speed / 10));
                    container.innerHTML = `
                        <div class="overlay-ticker" style="
                            color: ${overlay.text_color || '#ffffff'};
                            font-size: ${overlay.font_size || 24}px;
                            animation-duration: ${duration}s;
                        ">${overlay.message || ''}</div>
                    `;
                } else if (overlay.type === 'image' && overlay.image_path) {
                    container.innerHTML = `<img src="/${overlay.image_path}" class="overlay-image" />`;
                }
            });
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        function logout() {
            window.location.href = '/player/logout';
        }

        async function startPlayer() {
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('loading').classList.remove('hidden');
            
            player.imageEl = document.getElementById('imageContent');
            player.videoEl = document.getElementById('videoContent');
            player.debugEl = document.getElementById('debugInfo');
            
            debug('Player starting...');
            
            await fetchPlaylist();
            
            document.getElementById('loading').classList.add('hidden');
            
            player.heartbeatInterval = setInterval(sendHeartbeat, 30000);
            sendHeartbeat();
            
            player.refreshInterval = setInterval(fetchPlaylist, player.PLAYLIST_REFRESH_INTERVAL);
            
            if (player.playlist.length > 0) {
                debug('Starting playback with ' + player.playlist.length + ' items');
                player.currentIndex = 0;
                playCurrentItem();
            } else {
                debug('No content available');
                updateInfoDisplay(null);
            }
        }

        document.addEventListener('mousemove', showControls);
        document.addEventListener('mousedown', showControls);
        document.addEventListener('keydown', (e) => {
            showControls();
            if (e.key === ' ' || e.key === 'p') {
                e.preventDefault();
                togglePause();
            } else if (e.key === 'f' || e.key === 'F11') {
                e.preventDefault();
                toggleFullscreen();
            } else if (e.key === 'n') {
                e.preventDefault();
                debug('Manual skip');
                advanceToNext();
            }
        });

        window.addEventListener('beforeunload', () => {
            clearTimer();
            if (player.heartbeatInterval) clearInterval(player.heartbeatInterval);
            if (player.refreshInterval) clearInterval(player.refreshInterval);
        });
    </script>
</body>
</html>
